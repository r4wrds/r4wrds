{
  "hash": "1f2b1ed565cfa1cae473324436eae6af",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Function Junction\ndescription: 'Use, re-use, and write code to do stuff!\n\n  '\ncreative_commons: CC BY\n---\n\n\n\n\n\n\n:::obj\n\n**Functions**\n \n - Understand what a function is\n - Understand how to use functions in R\n - Write your own simple function\n\n:::\n\n## Functions\n\nWhat is a function? A function is simply a set of instructions or code written for a computer to follow. These can be very simple (multiply one column of data by another) to much more complex (multi-step model and visualization). Packages are usually sets of functions that focus on similar topics or themes, sort of like a cookbook for a specific kind of food. \n\nFunctions ultimately make our code more reusable and reproducible, because we can use functions for repeated processes (like cleaning and tidying data!).\n\n### What's in a Function?\n\nIn R, functions have a **name**, an **input** which may consist of one or more **arguments** (sometimes called parameters) and a **output** or the thing that the function returns. \n\nHere's an example function to convert discharge from cubic meters per second (cms) to cubic feet per second (cfs). Can you identify the different parts?\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncms_to_cfs <- function(discharge) {\n  cfs_out <- discharge * 35.3146662\n  return(cfs_out)\n}\n```\n:::\n\n\n\n\n### Running a Function\n\nUsing functions requires we know what pieces go where inside the function (*the arguments*), our data is of the right class or shape for the function (*input*), and we know what the function should return to our Environment! Once we have this basic understanding, there are thousands of functions that are already written and part of packages we can use. In fact, we've been using functions in every lesson thus far. In this module, we focus on building our own functions to meet our data science needs.  \n\nTo use the `cms_to_cfs` function we wrote above, we need to provide a value to the `discharge` **argument**. Let's convert 10 cms to cfs, using our function.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncms_to_cfs(discharge = 10)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 353.1467\n```\n\n\n:::\n:::\n\n\n\n\nThe function returns a numeric value to our console. If we wanted to save this value, we could assign it (`<-`) to an object. Functions allow us to iterate over data, or repeat the same task on different datasets without needing to re-write code every time.\n\n### Naming Functions in R\n\nIt's important to adopt consistent and descriptive names in R. This isn't just for functions, but it's a particularly good habit to practice when naming functions. For example, a general recommendation is to ðŸ `use_snake_case` ðŸ. Other options include:\n\n - `MaybeUseCamelCase`\n - `or.separate.by.periods`\n - `orJust_try.everythingBecause.CHAOS`\n\n<aside> For more useful info on naming conventions see [r4ds](http://r4ds.had.co.nz/workflow-basics.html#whats-in-a-name) or [example styles](http://style.tidyverse.org/syntax.html#object-names).\n</aside>\n\n## Use a Function from a Package\n\nWe've already been doing this throughout the previous lessons with things like `read.csv()`, `dplyr::filter()`, or `ggplot2::ggplot()`, but let's use a new package to pull some surface water river flow data. Here we'll use the `{dataRetrieval}` package.\n\n### Getting Water Data with `{dataRetrieval}`\n\nThe {[dataRetrieval](http://usgs-r.github.io/dataRetrieval/index.qmd)} package is a way to access hydrologic and water quality data from the USGS and EPA. There are several vignettes (or tutorials) available on the package website. Here, we will show how to download some surface water data from the American River near Sacramento. First we load the package with the functions we want to use. We load packages once per session. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load the functions via packages!\nlibrary(tidyverse)\nlibrary(dataRetrieval) # a spellbook of water data functions\n\n# use a function to download data:\nflow_site <- readNWISdata(site = \"11427000\", # USGS Station ID\n                          service = \"iv\", # instantaneous measurements\n                          parameterCd = \"00060\", # discharge in cfs\n                          startDate = \"2019-10-01\",\n                          endDate = \"2021-09-30\",\n                          tz = \"America/Los_Angeles\")\n```\n:::\n\n\n\n\nThere are a lot of **arguments** in that function! How did we know what each one was or what to put there? There are a few different options. For functions or packages you aren't familiar with, it's worth using built-in help. \n\n<aside>\nThe troubleshooting module has a section on [how to read R's built-in help](m_troubleshooting.qmd#using-built-in-help).\n</aside>\n\n - Look up help for a function with `?readNWISdata` and look at the **`Usage`** and **`Arguments`** sections!\n - Use tab autocomplete as much as you can in RStudio! Once inside a function's parenthesis, hit tab! There are generally a list of arguments that will pop up, each with some info about them. This is the same info we should find in the __*Help*__ tab when we look up the function.\n \n### How do we know it worked?\n\nAlways visualize and inspect your data... we should have an object in our environment called **`flow_site`**. Let's take a look at this data, tidy it, and plot!\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# check data\nsummary(flow_site)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  agency_cd           site_no             dateTime                  \n Length:70080       Length:70080       Min.   :2019-10-01 00:00:00  \n Class :character   Class :character   1st Qu.:2020-03-31 13:26:15  \n Mode  :character   Mode  :character   Median :2020-09-30 13:07:30  \n                                       Mean   :2020-09-30 12:39:55  \n                                       3rd Qu.:2021-04-01 11:48:45  \n                                       Max.   :2021-09-30 23:45:00  \n X_00060_00000     X_00060_00000_cd      tz_cd          \n Min.   :   9.68   Length:70080       Length:70080      \n 1st Qu.:  55.50   Class :character   Class :character  \n Median : 115.00   Mode  :character   Mode  :character  \n Mean   : 323.72                                        \n 3rd Qu.: 411.00                                        \n Max.   :4580.00                                        \n```\n\n\n:::\n\n```{.r .cell-code}\nhead(flow_site)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"agency_cd\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"site_no\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"dateTime\"],\"name\":[3],\"type\":[\"dttm\"],\"align\":[\"right\"]},{\"label\":[\"X_00060_00000\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"X_00060_00000_cd\"],\"name\":[5],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"tz_cd\"],\"name\":[6],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"USGS\",\"2\":\"11427000\",\"3\":\"2019-10-01 00:00:00\",\"4\":\"101\",\"5\":\"A\",\"6\":\"America/Los_Angeles\",\"_rn_\":\"1\"},{\"1\":\"USGS\",\"2\":\"11427000\",\"3\":\"2019-10-01 00:15:00\",\"4\":\"106\",\"5\":\"A\",\"6\":\"America/Los_Angeles\",\"_rn_\":\"2\"},{\"1\":\"USGS\",\"2\":\"11427000\",\"3\":\"2019-10-01 00:30:00\",\"4\":\"106\",\"5\":\"A\",\"6\":\"America/Los_Angeles\",\"_rn_\":\"3\"},{\"1\":\"USGS\",\"2\":\"11427000\",\"3\":\"2019-10-01 00:45:00\",\"4\":\"106\",\"5\":\"A\",\"6\":\"America/Los_Angeles\",\"_rn_\":\"4\"},{\"1\":\"USGS\",\"2\":\"11427000\",\"3\":\"2019-10-01 01:00:00\",\"4\":\"106\",\"5\":\"A\",\"6\":\"America/Los_Angeles\",\"_rn_\":\"5\"},{\"1\":\"USGS\",\"2\":\"11427000\",\"3\":\"2019-10-01 01:15:00\",\"4\":\"106\",\"5\":\"A\",\"6\":\"America/Los_Angeles\",\"_rn_\":\"6\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\n# fix column names so we can use a more informative parameter name\nflow_site <- dataRetrieval::renameNWISColumns(flow_site)\n\n# check data\nnames(flow_site)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"agency_cd\"    \"site_no\"      \"dateTime\"     \"Flow_Inst\"    \"Flow_Inst_cd\"\n[6] \"tz_cd\"       \n```\n\n\n:::\n\n```{.r .cell-code}\n# visualize:\nggplot(data = flow_site) + \n  geom_line(aes(x = dateTime, y = Flow_Inst), color = \"darkblue\") +\n  theme_classic() +\n  labs(x = \"\", y = \"Flow (cfs)\", \n       title = \"Discharge from USGS Station 11427000\",\n       caption = \"data pulled using {dataRetrieval} package in R\")\n```\n\n::: {.cell-output-display}\n![](m_functions_files/figure-html/flow-site-plot-1.png){width=672}\n:::\n:::\n\n\n\n\nAwesome! We plotted some discharge data from a river. That's great. We could save this data if we wanted (see the [import/export module](m_importing_and_exporting_data.qmd)), or do additional analysis (see next [module on joins](m_joins.qmd)!). Let's try using a different function here. \n\n:::challenge\n\n<font color=\"#009E73\">**Challenge 1: You Try!**</font> \n\n1. Using the code template below, create a `flow_huc` object using the `readNWISdata()` function but fill in the arguments with the following information:\n\n     - Instead of `site`, let's use `huc`. We'll try getting stations from HUC 18020111.\n     - Instead of `iv` (*instantaneous*), let's use `dv`.\n     - Use the same `startDate`, `endDate`, and `parameterCd` as we used above. \n     - `%>%` the output from `readNWISdata()` directly to the `renameNWISColumns()` function and then to the `addWaterYear()` function.\n\n2. How many unique `site_no` are there?\n3. Can you visualize the data using a `ggplot()` with `geom_line` and use a different color for each `site_no`?\n\n*Code template*:\n\n```\nflow_huc <- readNWISdata(___,\n                         ___,\n                         parameterCd = \"00060\", \n                         startDate = \"2019-10-01\",\n                         endDate = \"2021-09-30\") %>% \n  ___ %>% \n  ___\n  \n```\n\n:::\n\n\n<details>\n  <summary class=\"challenge-ans-title\"><font color=\"#0072B2\">**Click for Answers!**</font></summary>\n  <div class=\"challenge-ans-body\">\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# look for stations with daily values of discharge in the whole watershed\nflow_huc <- readNWISdata(huc = \"18020111\", # using a huc id number now\n                         service = \"dv\", # daily values\n                         parameterCd = \"00060\", \n                         startDate = \"2019-10-01\",\n                         endDate = \"2021-09-30\") %>% \n  renameNWISColumns() %>%  # the pipe infers that the data is passed through\n  addWaterYear()\n\nnames(flow_huc) # names look ok!\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"agency_cd\" \"site_no\"   \"dateTime\"  \"waterYear\" \"Flow\"      \"Flow_cd\"  \n[7] \"tz_cd\"    \n```\n\n\n:::\n\n```{.r .cell-code}\nunique(flow_huc$site_no) # 2 stations\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"11446500\" \"11447360\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# visualize:\nggplot() + \n  geom_line(data = flow_huc, \n            aes(x = dateTime, y = Flow, color = site_no), \n            show.legend = FALSE) +\n  theme_classic() +\n  labs(x = \"\", y = \"Flow (cfs)\", \n       title = \"Discharge from USGS Stations: 11446500, 11447360\",\n       caption = \"data pulled using {dataRetrieval} package in R\") +\n  # a new way to view data with facets...add a free scale!\n  facet_grid(rows = vars(site_no), scales = \"free\") \n```\n\n::: {.cell-output-display}\n![](m_functions_files/figure-html/challenge-1-1.png){width=672}\n:::\n:::\n\n\n\n\n  </div>\n</details>\n\n## Using Custom Functions\n\nSince we already wrote a custom function to convert cms to cfs, let's make another similar function but for cfs to cms, and apply it to the flow data we just downloaded. Let's look at how we might use a function on an existing data frame or dataset that we have in R.\n\n### Convert Flow Data to cms\n\nLet's use some of the `dplyr` we looked at in the last lesson. Here we want to make a new column that is our `Flow` data, but instead of in cfs, our units will be in cms. Let's use the **`flow_site`** data frame.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# the function\ncfs_to_cms <- function(discharge) {\n  cms_out <- discharge * 0.028316847\n  return(cms_out)\n}\n\n# add a new column to existing dataset with mutate\nflow_site <- flow_site %>% \n  mutate(Flow_cms = cfs_to_cms(Flow_Inst)) # apply the function to the column\n\n# quick plot to check!\nggplot() + \n  geom_line(data = flow_site, \n            aes(x = dateTime, y = Flow_cms), color = \"darkblue\") +\n  theme_classic() +\n  labs(x = \"\", y = \"Flow (cms)\", \n       title = \"Discharge from USGS Station 11427000\",\n       caption = \"data pulled using {dataRetrieval} package in R\")\n```\n\n::: {.cell-output-display}\n![](m_functions_files/figure-html/apply-cms-fun-1.png){width=672}\n:::\n:::\n\n\n\n\nSo what happened here? We made a function `cfs_to_cms()` to apply to our data. In this case, we wanted to apply our function to a column in our dataframe, which if we remember the earlier lesson on data, in a dataframe a column is a vector of the same type of data. That means the function can very quickly iterate through every observation in the vector and convert the data from cfs to cms.\n\n## More Practice\n\nThis section uses some more functions, but with some more advanced applications. We'll want to have the `{sf}` package installed for the following code to work fully.\n\n### Getting Water Quality Stations \n\nWhat if we wanted to find all the possible water quality stations that are upstream or downstream of the gage we pulled data from earlier (`USGS: 11446500`)? A great function that will not only help us figure that out, but also help us pull in spatial data we can use to make maps is the **`findNLDI()`** function from the `{dataRetrieval}` package.\n\nThe function **`findNLDI()`** has arguments for the type of data we want to use (`nwis`, `huc`,`location`), the direction along a stream to look (upstream or downstream, or in mainstem or tributaries), the data we want to get back (`find`), and the distance we should search upstream or downstream (`distance_km`).\n\nLet's look only in the mainstem river for 50 km upstream or downstream of our USGS gage and return any NWIS (water quality or flow) sites and the associated flowlines we searched.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sf)\n\n# get NWIS and flowline data 50km downstream of the USGS gage\namer_ds_nimbus <- findNLDI(\n  nwis = \"11446500\", # Below Nimbus Dam\n  nav = c(\"UM\",\"DM\"), \n  find = c(\"nwis\", \"flowlines\"),\n  distance_km = 50)\n\nnames(amer_ds_nimbus)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"origin\"       \"UM_nwissite\"  \"UM_flowlines\" \"DM_nwissite\"  \"DM_flowlines\"\n```\n\n\n:::\n:::\n\n\n\n\nNote, this returned a named *list* of dataframes. We can access individual parts of a list just as we can access a single column in a dataframe using the `$`. This function returned 5 parts, the `origin` which is the site we used to start our search, the `UM_nwissite` which is the NWIS sites upstream on the mainstem from our USGS gage, the `DM_nwissite` which is the NWIS sites downstream of our USGS gage, and finally, a mainstem flowline upstream and downstream of our gage. These are dataframes with an underlying spatial component, which is nice because it allows us to easily map and visualize these data if we want. See the [mapmaking lesson](m_intro_mapmaking.qmd) for more info.The dataframes are an `sf` class, from the [simple features {sf} package](https://r-spatial.github.io/sf/), but they can also be converted to into a dataframe. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# check the object class \nclass(amer_ds_nimbus$DM_nwissite)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"sf\"         \"tbl_df\"     \"tbl\"        \"data.frame\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# get just downstream NWIS sites and make into dataframe\nnwis_sites <- amer_ds_nimbus$DM_nwissite %>% \n  st_drop_geometry() # drop the sf class\n\n# verify the class has changed\nclass(nwis_sites)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"tbl_df\"     \"tbl\"        \"data.frame\"\n```\n\n\n:::\n:::\n\n\n\n\nLet's visualize these sites with a fancy map! See the [mapmaking](m_intro_mapmaking.qmd) lesson for more details on making maps in R.\n\n\n\n\n\n\n::: {.cell preview='true'}\n::: {.cell-output-display}\n![](images/map_of_nwis_sites.png){width=90%}\n:::\n:::\n\n\n\n\n### Save Our Data!\n\nFinally, let's go ahead and save (export) our list of NWIS sites, and all our spatial components from the American River below Nimbus Dam so we can use it for future lessons.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# save out\nwrite_csv(nwis_sites, path = \"data/nwis_sites_american_river.csv\")\nwrite_rds(amer_ds_nimbus, path = \"data/nwis_sites_amer_ds_nimbus_sf.rds\")\n```\n:::\n\n\n\n\n\n## Additional Water Packages of Interest\n\nThere are many packages that work with water or water data. Here's a list of just a few that you may find interesting or helpful. The R CRAN repository has a list of all packages that relate to [Hydrology](https://cran.r-project.org/web/views/Hydrology.html) that is also a good place to look.\n\n - **{dataRetrieval}**\n - **{nhdplusTools}**\n - **{EGRET}**\n - **{geoknife}**\n\n\n<br>  \n\n\n",
    "supporting": [
      "m_functions_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}