{
  "hash": "5784d2613e4defcb12e6b7269f669372",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Parameterized reports\ndescription: 'How to automate routine reporting\n\n  '\ncreative_commons: CC BY\npreview: https://r4wrds.com/img/cover.png\n---\n\n\n\n\n\n\n::: {.obj}\n**Learning objectives**\n\n-   Extend functional programming skills to automate `.Rmd` reports  \n-   Understand the available types of reports provided by `rmarkdown`  \n:::\n\n<br>\n\n> \"Your success in life will be determined largely by your ability to speak, your ability to write, and the quality of your ideas, in that order.\" â€” [Patrick Winston (1943-2019)](https://www.youtube.com/watch?v=Unzc731iCUY&t=37s)\n\nData science is the art of combining domain knowledge, statistics, math, programming, and visualization to find order and meaning in disorganized information. Communicating the results of your analyses, or ability to make data \"speak\", is of utmost importance. The modern day open source package ecosystem is full of powerful ways to give voice to our analyses.\n\nAnalyses typically lead to figures, tables, and interpretation of these information. The [`rmarkdown`](https://rmarkdown.rstudio.com/) package provides `R` users with a standardized approach for turning `R` analyses into reports, documents, presentations, dashboards, and websites. In this module, we assume familiarity with `rmarkdown`, and extend the previous modules on iteration, functional programming, and reproducible workflows to demonstrate how to iterate over reports.\n\n<aside>\nReview the [introduction to `rmarkdown`](../intro/m_intro_Rmarkdown.qmd) if needed.\n</aside>\n\nAccording to [R Markdown: The Definitive Guide](https://bookdown.org/yihui/rmarkdown/params-declare.html), some example use cases for creating a parameterized report include:  \n\n- Showing results for a specific geographic location.  \n- Running a report that covers a specific time period.  \n- Running a single analysis multiple times for different assumptions.  \n- Controlling the behavior of knitr (e.g., specify if you want the code to be displayed or not).  \n\nIn this module, we will focus on the first case, and build parameterized reports for a set of geographic locations. Throughout this course, we've been working with groundwater elevation data across California counties. Let's imagine that we want to generate a report on groundwater level trends for a set of counties.\n\nAlthough the RStudio Interactive Development Environment (IDE) encourages knitting RMarkdown documents by clicking a button, we can also knit documents via: `rmarkdown::render()`. Iterating over `render()` is the key to scaling parameterized reports. To iterate over R Markdown reports, we must first understand how to use `params`.  \n\n\n\n\n\n::: {.cell}\n\n:::\n\n\n\n\n\n<br>\n\n## `params`\n\nA parameterized .Rmd file takes a set of `params` (short for \"parameters\") in the YAML header, which are bound into a named list called `params` and accessed with code from within the .Rmd file with `params$<paramater-name>`. For example, consider the example YAML:\n\n```\ntitle: \"My awesome paramaterized report\"\noutput: html_document\nparams:\n  start_date: 2021-01-01\n  watershed: Yuba\n  data: gwl_yuba.csv\n```\n\nIn the code, we could then access the value `\"2021-01-01\"` with `params$start_date`. Similarly, `params$watershed` will equal `\"Yuba\"` and `params$data` will equal `\"gwl_yuba.csv\"`.\n\n\n<br>\n\n## Set up a report with `params`\n\nLet's apply `params` to our task and generate an `html_document` for a set of counties. To illustrate, we will use a simplified, pre-processed dataset of 3 counties (Sacramento, Yolo, and San Joaquin counties). If you're motivated to do so, you can use the entire groundwater level dataset of > 2 million records to scale the process to all counties. Read in the data and take a look at the fields.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\n\n# groundwater level data for Sacramento, Yolo, San Joaquin counties\ngwl <- read_rds(\"data/sac_yolo_sj.rds\")\n\ngwl %>% \n  group_by(SITE_CODE) %>% \n  slice(1) %>% \n  plot()\n```\n\n::: {.cell-output-display}\n![](m_parameterized_reports_files/figure-html/read-counties-1.png){width=672}\n:::\n:::\n\n\n\n\nWe will iterate over the `COUNTY_NAME` to create three reports, one for each county. Copy and paste the following code into a new file `reports/gwl_report.Rmd`\n\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n````\n---\ntitle: \"`r paste(params$county, 'Groundwater Levels')`\"\noutput: html_document\nparams:\n  county: \"placeholder\"\n---\n\n<br>\n\n```{r, echo = FALSE, message = FALSE, error = FALSE, warning = FALSE}\nlibrary(tidyverse)\nlibrary(here)\nlibrary(sf)\nlibrary(mapview)\nlibrary(maps)\nlibrary(DT)\nmapviewOptions(fgb = FALSE)\n\nknitr::opts_chunk$set(warning = FALSE, message = FALSE, out.width = \"100%\")\n\n# filter all groundwater level data (already loaded into memory) by \n# the supplied county\nd <- filter(gwl, COUNTY_NAME == params$county)\n\n# extract the county spatial file\ncounty_sf <- st_as_sf(map(\"county\", plot = FALSE, fill = TRUE)) %>% \n  filter(ID == paste0(\"california,\", tolower(params$county)))\n\n```\n\n\nThis report shows groundwater levels in `r params$county` county.\n\nDates range from `r min(d$MSMT_DATE, na.rm = TRUE)` to `r max(d$MSMT_DATE, na.rm = TRUE)`.\n\nData source: [DWR Periodic Groundwater Level Database](https://data.cnra.ca.gov/dataset/periodic-groundwater-level-measurements).\n\n<br>\n\n## Distribution of measurements over time\n\n50% of measured values occur on or after `r median(d$MSMT_DATE, na.rm = TRUE)`.\n\n```{r hist, echo = FALSE}\nd %>% \n  ggplot() +\n  geom_histogram(aes(MSMT_DATE)) +\n  theme_minimal() +\n  labs(title = \"\", x = \"\", y = \"Count\")\n```\n\n\n<br>\n\n## Monitoring sites\n\n```{r map, echo = FALSE}\n# mapview of county outline\ncounty_mv <- mapview(\n  county_sf, layer.name = paste(params$county, \"county\"), \n  lwd = 2, color = \"red\", alpha.regions = 0\n)\n\n# mapview of monitoring points\npoints_mv <- d %>% \n  group_by(SITE_CODE) %>% \n  slice(1) %>% \n  select(-MSMT_DATE) %>% # remove msmt date b/c its irrelevant\n  mapview(layer.name = \"Monitoring stations\")\n\ncounty_mv + points_mv\n```\n\n<br>\n\n## All groundwater levels\n\n```{r plot, echo = FALSE}\n# interactive hydrograph\np <- ggplot(d, aes(MSMT_DATE, WSE, color = SITE_CODE)) + \n  geom_line(alpha = 0.5) +\n  guides(color = FALSE)\nplotly::ggplotly(p)\n```\n\n<br> \n\n```{r dt, echo = FALSE}\n# data table of median groundwater level per site, per year\nd %>% \n  select(-c(\"COUNTY_NAME\", \"WELL_DEPTH\")) %>%\n  st_drop_geometry() %>% \n  mutate(YEAR = lubridate::year(MSMT_DATE)) %>% \n  group_by(SITE_CODE, YEAR) %>% \n  summarise(WSE_MEDIAN = median(WSE, na.rm = TRUE)) %>%\n  ungroup() %>% \n  DT::datatable(\n    extensions = 'Buttons', options = list(\n      dom = 'Bfrtip',\n      buttons = \n        list('copy', 'print', list(\n          extend  = 'collection',\n          buttons = c('csv', 'excel', 'pdf'),\n          text    = 'Download'\n        ))\n    )\n  )\n```\n\n\n***\n\nReport generated on `r Sys.Date()`.\n````\n\n\n:::\n:::\n\n\n\n\n\n::: {.challenge}\n**Pause and think**\n\nTake a moment to read the `.Rmd` file above and see what it does. Notice where `params$county` is located in the document. Particularly, in the first code chunk it's used to filter the groundwater level data (assumed to be in memory so we only load it once rather than every time we run this script) down to the county parameter.\n\n```\nd <- filter(gwl, COUNTY_NAME == params$county)\n```\n\nNext, how might you write an `.Rmd` file like the one above and test that everything looks the way you want it to before calling it done? In other words, would you start by writing `params$county` in all places it needs to be or start with one county, make sure everything works, and then substitute in `params$county`?  \n\n:::\n\n\n\n<br>\n\n## Iterate over a report\n\nFinally, we create a vector of counties we want to write reports for and iterate over them. We also need to specify the output location of each file. Since we are writing `html_documents`, the file extension is `.html`. Using `walk2()` from our functional programming toolkit, we can pass in the counties vector and the output file paths into `rmarkdown::render()` and silently write the files. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# unique counties to write reports for\ncounties  <- unique(gwl$COUNTY_NAME)\n\n# output file names\nfiles_out <- tolower(counties) %>% \n  str_replace_all(\" \", \"_\") %>% \n  paste0(., \".html\")\n\n# silently (walk) over the county names and file names, \n# creating a report for each combination\nwalk2(\n  counties, \n  files_out,\n  ~rmarkdown::render(\n    input       = \"reports/gwl_report.Rmd\", \n    output_file = here(\"reports\", .y),\n    params      = list(county = .x)\n  )\n)\n```\n:::\n\n\n\n\nOpen and explore each of the files that were written. \n\n\n<br>\n\n::: {.challenge}\n**Pause and think**\n\nIf we wanted to automate reports like this and have them published online or emailed to our team every morning at 7AM, what tools would we need? \n\nHint: see the [automation module section on task schedulers](m_reproducible_workflows.qmd#task-scheduling).\n\n:::\n\n\n\n\n<br>\n\n## In-line `R`\n\nWithin an `.Rmd` we can insert `R` code in-line using the following syntax:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n`r <function>`\n```\n:::\n\n\n\n  \nSo for instance we can write a string like: \n\n\n\n\n::: {.cell}\n\n```{.md .cell-code}\nThe mean of 1 and 3 is `r mean(c(1,3))`.\n```\n:::\n\n\n\n\nAnd when the document knits, we get: The mean of 1 and 3 is 2.\n\nConsider this as an approach to add specific output about each site in the text narrative.\n\n\n<br>\n\n## Additional Resources\n\nAlthough we only demonstrated one type of output report in this module, the `html_document`, there are many other output formats that you can parameterize and iterate over, including [Word documents](https://bookdown.org/yihui/rmarkdown/word-document.html), [PDFs](https://bookdown.org/yihui/rmarkdown/pdf-document.html), [flexdashboards](https://pkgs.rstudio.com/flexdashboard/index.qmd), and presentations. \n\n<aside>\nView some of the available [R Markdown output formats here](https://rmarkdown.rstudio.com/formats.html).\n</aside>\n\nTo dig deeper, see the official [RMarkdown guide for paramaterized reports](https://bookdown.org/yihui/rmarkdown/parameterized-reports.html).   \n\n\n<br>\n\n\n",
    "supporting": [
      "m_parameterized_reports_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}