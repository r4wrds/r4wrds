---
### Click the RUN DOCUMENT 
### (the green "Play" button") in RStudio to run worksheet!
title: "Data Visualization"
author: "R. Peek"
output: 
  learnr::tutorial:
    df_print: default
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(learnr)
library(tidyverse)

knitr::opts_chunk$set(echo = FALSE, comment = "")

webpath <- "https://data.ca.gov/dataset/ab672540-aecd-42f1-9b05-9aad326f97ec/resource/c6f760be-b94f-495e-aa91-2d8e6f426e11/download/fhab_bloomreport_portal.csv"
habs <- readr::read_csv(webpath)


habs_clean <- habs %>% 
  # get rid of NAs
  filter(!is.na(Latitude)) %>% 
  # remove the outliers from Latitude (should be positive and between 32-42)
  filter(Latitude > 32, Latitude < 42) %>% 
  # remove the outliers from Longitude (should be negative and between 115-125)
  filter(Longitude > -125, Longitude < -115)

# Let's add a column that is River and Lake to simplify:
habs_clean <- habs_clean %>% 
  mutate(habtype = case_when(
    grepl("river", WaterBodyType, ignore.case = TRUE) ~ "River",
    grepl("lake", WaterBodyType, ignore.case = TRUE) ~ "Lake",
    TRUE ~ "Other"))
```

<br>

This worksheet will help you work through some examples of some data visualization skills using the `{ggplot}` package. You'll need an internet connection for this worksheet to work.

You can write code into the code boxes and click the "**Run Document**" box to interact or answer the prompts. Some boxes may have __*Hints*__, click the box to find out more!

# Data Visualization

After you are able to import data, the natural extension to working with data is the ability to visualize and communicate with those data. Sometimes this process is iterative and exploratory, at other points there is a specific objective and plot that is required for reporting or comparison purposes. The grammar of graphics (the root of **g** **g** *plot*) is based on the idea that any plot needs three basic components:

 - `data`: The dataset you want to visualize
 - `geom`: A type of geometric representation of the data (i.e., points, lines, dots, bars...)
 - `aes`: The aesthetics of the geometry. What color, size, transparency, shape do we want to use for our `geometry` and what data might these aesthetics link with? 
 
The `ggplot` package is an amazingly powerful graphics library that allows us to do pretty much whatever we want, from a simple plot, to immensely complex visualizations of our data.

We covered a number of different ways to import data in R in the lesson on [importing and exporting data](https://www.r4wrds.com/intro/m_importing_and_exporting_data.html).

Here we will work with some California Surface Water Data, stored online as a csv. We'll read that data in directly from a web path, do some wrangling, and try to visualize it in a few different ways. 

## Import Harmful Algal Bloom Data 

First we will read in some data on Harmful Algal Blooms, or "**HABs**". To see more about these data, see [this webpage on the California Open Data Portal](https://data.ca.gov/dataset/surface-water-freshwater-harmful-algal-blooms). How many columns are in our data? How many NAs are in the Latitude column? Is the data clean enough to use?

```{r get-habs, exercise = TRUE}

webpath <- "https://data.ca.gov/dataset/ab672540-aecd-42f1-9b05-9aad326f97ec/resource/c6f760be-b94f-495e-aa91-2d8e6f426e11/download/fhab_bloomreport_portal.csv"

habs <- read_csv(webpath)
# how many columns?
# how NAs in the Latitude column?
___(is.na(habs___))

```

```{r get-habs-hint-1}

webpath <- "https://data.ca.gov/dataset/ab672540-aecd-42f1-9b05-9aad326f97ec/resource/c6f760be-b94f-495e-aa91-2d8e6f426e11/download/fhab_bloomreport_portal.csv"

habs <- read_csv(webpath)

dim(habs) # 24 columns
ncol(habs)

___(is.na(habs$Latitude))

```


```{r get-habs-solution}

webpath <- "https://data.ca.gov/dataset/ab672540-aecd-42f1-9b05-9aad326f97ec/resource/c6f760be-b94f-495e-aa91-2d8e6f426e11/download/fhab_bloomreport_portal.csv"

habs <- read_csv(webpath)

dim(habs) # 24 columns
ncol(habs)

sum(is.na(habs$Latitude))
# could also use:
# summary(habs)
```

## Clean the Data

Rarely is a dataset fully ready as soon as you get it. Let's clean it up using some of our wrangling skills. Here we need to remove NAs for Latitude and Longitude, and at a column associated with any Habitat Type that is "Lake" or "River".

```{r clean, exercise = TRUE}

habs_clean <- habs %>% 
  # get rid of NAs
  filter(!is.na(___)) %>% 
  # remove the outliers from Latitude (should be positive and between 32-42)
  filter(Latitude > 32, Latitude < 42) %>% 
  # remove the outliers from Longitude (should be negative and between 115-125)
  filter(Longitude > -125, Longitude < -115)
         
# see how many types are actually the same! 
___(habs_clean$WaterBodyType)

# Let's add a column that is River and Lake to simplify
# grepl is a way to search for words in a column of interest
# what words should we use?
habs_clean <- habs_clean %>% 
  mutate(habtype = case_when(
    grepl("___", WaterBodyType, ignore.case = ___) ~ "River",
    grepl("___", WaterBodyType, ignore.case = ___) ~ "Lake"),
    TRUE ~ "Other")

```

What happens when we use `ignore.case=FALSE`?

```{r clean-solution}

habs_clean <- habs %>% 
  # get rid of NAs
  filter(!is.na(Latitude)) %>% 
  # remove the outliers from Latitude (should be positive and between 32-42)
  filter(Latitude > 32, Latitude < 42) %>% 
  # remove the outliers from Longitude (should be negative and between 115-125)
  filter(Longitude > -125, Longitude < -115)
         
# see how many Water Body Types are actually the same! 
table(habs_clean$WaterBodyType)

# Let's add a column that is River and Lake to simplify:
habs_clean <- habs_clean %>% 
  mutate(habtype = case_when(
    grepl("river", WaterBodyType, ignore.case = TRUE) ~ "River",
    grepl("lake", WaterBodyType, ignore.case = TRUE) ~ "Lake",
    TRUE ~ "Other"))

```

```{r cleansetup, echo=FALSE, eval=TRUE}

habs_clean <- habs %>% 
  # get rid of NAs
  filter(!is.na(Latitude)) %>% 
  # remove the outliers from Latitude (should be positive and between 32-42)
  filter(Latitude > 32, Latitude < 42) %>% 
  # remove the outliers from Longitude (should be negative and between 115-125)
  filter(Longitude > -125, Longitude < -115)

# Let's add a column that is River and Lake to simplify:
habs_clean <- habs_clean %>% 
  mutate(habtype = case_when(
    grepl("river", WaterBodyType, ignore.case = TRUE) ~ "River",
    grepl("lake", WaterBodyType, ignore.case = TRUE) ~ "Lake",
    TRUE ~ "Other"))

```


# Plotting

Now we can at move forward with our cleaned dataset.

## Barplots

Let's start with a simple barplot. Commonly used to compare the amounts or counts across categories. Let's plot how many records exist in each `CountyID`.

```{r barplot, echo=TRUE}

# a simple barplot
ggplot(data=habs_clean) + geom_bar(aes(CountyID))

```

What if we want to arrange this plot by the total amount from largest to smallest? We need our data to be a `factor` to be ordered from largest to smallest. Here we can use the `forcats` package to order by the frequency of a variable.

```{r barplot2, echo=TRUE}

# Use the "forcats" package
ggplot(data = habs_clean) +
  geom_bar( aes(
    forcats::fct_infreq( as.factor(CountyID) ) ) ) +
  labs(x="County ID")

```

## Line Plots

What about the number of records over time? Let's look at how many records exist over time. We can change the `geom` and the `aesthetics` here to make some colors or shapes different. Let's use a summarize by year option here with the `lubridate::year()` package. We can use a data variable in the `aes( )` to map data to a color, shape, etc. Let's try with `habtype`!

```{r lineplot, echo=TRUE}

habs_clean2 <- habs_clean %>% 
  group_by(year = lubridate::year(ObservationDate), habtype) %>%
  tally()
ggplot(data=habs_clean2) + geom_line(aes(x=year, y=n, color=habtype))

```

## Box Plots

A common way to compare distributions of data is using boxplots. Let's look at the distribution of data by `habtype` by date.

```{r boxplot, echo=TRUE}

ggplot(habs_clean) + geom_boxplot(aes(x=habtype, y=ObservationDate))

```

What does this boxplot tell us? What if we wanted to see the years on the x-axis? A quick way to make this possible (aside from just switching the x and y arguments) is the `coord_flip()` option.

```{r boxplot2, echo=TRUE}

ggplot(habs_clean) + geom_boxplot(aes(x=habtype, y=ObservationDate)) +
  coord_flip() +
  labs(x="", y="Obs. Date")

```

Seems that while the data ranges are pretty similar for *River* and *Lake* types, the bulk of the data for *Rivers* is more recent.

How can we visualize this distribution a bit more? Let's use a `violin` plot.

```{r boxviolin}

ggplot(habs_clean) + geom_violin(aes(x=habtype, y=ObservationDate)) +
  labs(x="", y="Obs. Date")

```

This shows the same data, but now the wider areas indicate where more data exists, and we can see the weight is closer to more recent dates in `River` habitat types. Why not plot the actual data on top of this? Let's do that, with `points`.

## Point Plots

The great thing about `ggplot` is we can **layer** our data. Which means we can use the same or different data sets and stack them on top (visually) of one another to provide different perspectives. Here maybe instead of the violin plot, we could show the boxplot, but then show all the individual points behind each habitat type. That requires two additional things to think about...a new layer (`geom_point`), and transparency.

```{r pointplot}

ggplot(habs_clean) + 
  geom_boxplot(aes(x=habtype, y=ObservationDate)) +
  geom_point(aes(x=habtype, y=ObservationDate)) +
  labs(x="", y="Obs. Date")

```

Not so helpful. What about using a `jitter` option to spread the points out a bit so they are easier to see *without changing the underlying data*? Can you also change the underlying transparency so the points aren't covering the boxplots?


```{r pointplot2, exercise=TRUE}

ggplot(habs_clean) + 
  geom_boxplot(aes(x=habtype, y=ObservationDate)) +
  geom___(aes(x=habtype, y=ObservationDate) ___) +
  labs(x="", y="Obs. Date")

```

```{r pointplot2-solution}

ggplot(habs_clean) + 
  geom_boxplot(aes(x=habtype, y=ObservationDate)) +
  geom_jitter(aes(x=habtype, y=ObservationDate), alpha=0.2) +
  labs(x="", y="Obs. Date")

```


```{r pointplot2-print}

ggplot(habs_clean) + 
  geom_boxplot(aes(x=habtype, y=ObservationDate)) +
  geom_jitter(aes(x=habtype, y=ObservationDate), alpha=0.2) +
  labs(x="", y="Obs. Date")

```

Many ways to tell a story! 





