<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #a0a0a0;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
div.sourceCode
  { color: #1f1c1b; background-color: #ffffff; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #1f1c1b; } /* Normal */
code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
code span.an { color: #ca60ca; } /* Annotation */
code span.at { color: #0057ae; } /* Attribute */
code span.bn { color: #b08000; } /* BaseN */
code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #924c9d; } /* Char */
code span.cn { color: #aa5500; } /* Constant */
code span.co { color: #898887; } /* Comment */
code span.cv { color: #0095ff; } /* CommentVar */
code span.do { color: #607880; } /* Documentation */
code span.dt { color: #0057ae; } /* DataType */
code span.dv { color: #b08000; } /* DecVal */
code span.er { color: #bf0303; text-decoration: underline; } /* Error */
code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
code span.fl { color: #b08000; } /* Float */
code span.fu { color: #644a9b; } /* Function */
code span.im { color: #ff5500; } /* Import */
code span.in { color: #b08000; } /* Information */
code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
code span.op { color: #1f1c1b; } /* Operator */
code span.ot { color: #006e28; } /* Other */
code span.pp { color: #006e28; } /* Preprocessor */
code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #ff5500; } /* SpecialString */
code span.st { color: #bf0303; } /* String */
code span.va { color: #0057ae; } /* Variable */
code span.vs { color: #bf0303; } /* VerbatimString */
code span.wa { color: #bf0303; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
  <title>R for Water Resources Data Science: Reproducible workflows and automation</title>

  <meta property="description" itemprop="description" content="How to make computers do your bidding"/>



  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="R for Water Resources Data Science: Reproducible workflows and automation"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="How to make computers do your bidding"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:site_name" content="R for Water Resources Data Science"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="R for Water Resources Data Science: Reproducible workflows and automation"/>
  <meta property="twitter:description" content="How to make computers do your bidding"/>

  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","output"]}},"value":[{"type":"character","attributes":{},"value":["Reproducible workflows and automation"]},{"type":"character","attributes":{},"value":["How to make computers do your bidding  \n"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["toc"]}},"value":[{"type":"logical","attributes":{},"value":[true]}]}]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  <!--radix_placeholder_navigation_in_header-->
  <meta name="distill:offset" content=""/>

  <script type="application/javascript">

    window.headroom_prevent_pin = false;

    window.document.addEventListener("DOMContentLoaded", function (event) {

      // initialize headroom for banner
      var header = $('header').get(0);
      var headerHeight = header.offsetHeight;
      var headroom = new Headroom(header, {
        tolerance: 5,
        onPin : function() {
          if (window.headroom_prevent_pin) {
            window.headroom_prevent_pin = false;
            headroom.unpin();
          }
        }
      });
      headroom.init();
      if(window.location.hash)
        headroom.unpin();
      $(header).addClass('headroom--transition');

      // offset scroll location for banner on hash change
      // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
      window.addEventListener("hashchange", function(event) {
        window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
      });

      // responsive menu
      $('.distill-site-header').each(function(i, val) {
        var topnav = $(this);
        var toggle = topnav.find('.nav-toggle');
        toggle.on('click', function() {
          topnav.toggleClass('responsive');
        });
      });

      // nav dropdowns
      $('.nav-dropbtn').click(function(e) {
        $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
        $(this).parent().siblings('.nav-dropdown')
           .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $("body").click(function(e){
        $('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $(".nav-dropdown").click(function(e){
        e.stopPropagation();
      });
    });
  </script>

  <style type="text/css">

  /* Theme (user-documented overrideables for nav appearance) */

  .distill-site-nav {
    color: rgba(255, 255, 255, 0.8);
    background-color: #0F2E3D;
    font-size: 15px;
    font-weight: 300;
  }

  .distill-site-nav a {
    color: inherit;
    text-decoration: none;
  }

  .distill-site-nav a:hover {
    color: white;
  }

  @media print {
    .distill-site-nav {
      display: none;
    }
  }

  .distill-site-header {

  }

  .distill-site-footer {

  }


  /* Site Header */

  .distill-site-header {
    width: 100%;
    box-sizing: border-box;
    z-index: 3;
  }

  .distill-site-header .nav-left {
    display: inline-block;
    margin-left: 8px;
  }

  @media screen and (max-width: 768px) {
    .distill-site-header .nav-left {
      margin-left: 0;
    }
  }


  .distill-site-header .nav-right {
    float: right;
    margin-right: 8px;
  }

  .distill-site-header a,
  .distill-site-header .title {
    display: inline-block;
    text-align: center;
    padding: 14px 10px 14px 10px;
  }

  .distill-site-header .title {
    font-size: 18px;
    min-width: 150px;
  }

  .distill-site-header .logo {
    padding: 0;
  }

  .distill-site-header .logo img {
    display: none;
    max-height: 20px;
    width: auto;
    margin-bottom: -4px;
  }

  .distill-site-header .nav-image img {
    max-height: 18px;
    width: auto;
    display: inline-block;
    margin-bottom: -3px;
  }



  @media screen and (min-width: 1000px) {
    .distill-site-header .logo img {
      display: inline-block;
    }
    .distill-site-header .nav-left {
      margin-left: 20px;
    }
    .distill-site-header .nav-right {
      margin-right: 20px;
    }
    .distill-site-header .title {
      padding-left: 12px;
    }
  }


  .distill-site-header .nav-toggle {
    display: none;
  }

  .nav-dropdown {
    display: inline-block;
    position: relative;
  }

  .nav-dropdown .nav-dropbtn {
    border: none;
    outline: none;
    color: rgba(255, 255, 255, 0.8);
    padding: 16px 10px;
    background-color: transparent;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    margin: 0;
    margin-top: 1px;
    z-index: 2;
  }

  .nav-dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 200px;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 4px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
    z-index: 1;
    margin-top: 2px;
    white-space: nowrap;
    padding-top: 4px;
    padding-bottom: 4px;
  }

  .nav-dropdown-content hr {
    margin-top: 4px;
    margin-bottom: 4px;
    border: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .nav-dropdown-active {
    display: block;
  }

  .nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
    color: black;
    padding: 6px 24px;
    text-decoration: none;
    display: block;
    text-align: left;
  }

  .nav-dropdown-content .nav-dropdown-header {
    display: block;
    padding: 5px 24px;
    padding-bottom: 0;
    text-transform: uppercase;
    font-size: 14px;
    color: #999999;
    white-space: nowrap;
  }

  .nav-dropdown:hover .nav-dropbtn {
    color: white;
  }

  .nav-dropdown-content a:hover {
    background-color: #ddd;
    color: black;
  }

  .nav-right .nav-dropdown-content {
    margin-left: -45%;
    right: 0;
  }

  @media screen and (max-width: 768px) {
    .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
    .distill-site-header a.nav-toggle {
      float: right;
      display: block;
    }
    .distill-site-header .title {
      margin-left: 0;
    }
    .distill-site-header .nav-right {
      margin-right: 0;
    }
    .distill-site-header {
      overflow: hidden;
    }
    .nav-right .nav-dropdown-content {
      margin-left: 0;
    }
  }


  @media screen and (max-width: 768px) {
    .distill-site-header.responsive {position: relative; min-height: 500px; }
    .distill-site-header.responsive a.nav-toggle {
      position: absolute;
      right: 0;
      top: 0;
    }
    .distill-site-header.responsive a,
    .distill-site-header.responsive .nav-dropdown {
      display: block;
      text-align: left;
    }
    .distill-site-header.responsive .nav-left,
    .distill-site-header.responsive .nav-right {
      width: 100%;
    }
    .distill-site-header.responsive .nav-dropdown {float: none;}
    .distill-site-header.responsive .nav-dropdown-content {position: relative;}
    .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
      display: block;
      width: 100%;
      text-align: left;
    }
  }

  /* Site Footer */

  .distill-site-footer {
    width: 100%;
    overflow: hidden;
    box-sizing: border-box;
    z-index: 3;
    margin-top: 30px;
    padding-top: 30px;
    padding-bottom: 30px;
    text-align: center;
  }

  /* Headroom */

  d-title {
    padding-top: 6rem;
  }

  @media print {
    d-title {
      padding-top: 4rem;
    }
  }

  .headroom {
    z-index: 1000;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }

  .headroom--transition {
    transition: all .4s ease-in-out;
  }

  .headroom--unpinned {
    top: -100px;
  }

  .headroom--pinned {
    top: 0;
  }

  /* adjust viewport for navbar height */
  /* helps vertically center bootstrap (non-distill) content */
  .min-vh-100 {
    min-height: calc(100vh - 100px) !important;
  }

  </style>

  <script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
  <link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
  <link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
  <script src="site_libs/headroom-0.9.4/headroom.min.js"></script>
  <script src="site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
  <script src="site_libs/fuse-6.4.1/fuse.min.js"></script>

  <script type="application/javascript">

  function getMeta(metaName) {
    var metas = document.getElementsByTagName('meta');
    for (let i = 0; i < metas.length; i++) {
      if (metas[i].getAttribute('name') === metaName) {
        return metas[i].getAttribute('content');
      }
    }
    return '';
  }

  function offsetURL(url) {
    var offset = getMeta('distill:offset');
    return offset ? offset + '/' + url : url;
  }

  function createFuseIndex() {

    // create fuse index
    var options = {
      keys: [
        { name: 'title', weight: 20 },
        { name: 'categories', weight: 15 },
        { name: 'description', weight: 10 },
        { name: 'contents', weight: 5 },
      ],
      ignoreLocation: true,
      threshold: 0
    };
    var fuse = new window.Fuse([], options);

    // fetch the main search.json
    return fetch(offsetURL('search.json'))
      .then(function(response) {
        if (response.status == 200) {
          return response.json().then(function(json) {
            // index main articles
            json.articles.forEach(function(article) {
              fuse.add(article);
            });
            // download collections and index their articles
            return Promise.all(json.collections.map(function(collection) {
              return fetch(offsetURL(collection)).then(function(response) {
                if (response.status === 200) {
                  return response.json().then(function(articles) {
                    articles.forEach(function(article) {
                      fuse.add(article);
                    });
                  })
                } else {
                  return Promise.reject(
                    new Error('Unexpected status from search index request: ' +
                              response.status)
                  );
                }
              });
            })).then(function() {
              return fuse;
            });
          });

        } else {
          return Promise.reject(
            new Error('Unexpected status from search index request: ' +
                        response.status)
          );
        }
      });
  }

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // get search element (bail if we don't have one)
    var searchEl = window.document.getElementById('distill-search');
    if (!searchEl)
      return;

    createFuseIndex()
      .then(function(fuse) {

        // make search box visible
        searchEl.classList.remove('hidden');

        // initialize autocomplete
        var options = {
          autoselect: true,
          hint: false,
          minLength: 2,
        };
        window.autocomplete(searchEl, options, [{
          source: function(query, callback) {
            const searchOptions = {
              isCaseSensitive: false,
              shouldSort: true,
              minMatchCharLength: 2,
              limit: 10,
            };
            var results = fuse.search(query, searchOptions);
            callback(results
              .map(function(result) { return result.item; })
            );
          },
          templates: {
            suggestion: function(suggestion) {
              var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
                ? `<img src="${offsetURL(suggestion.preview)}"</img>`
                : '';
              var html = `
                <div class="search-item">
                  <h3>${suggestion.title}</h3>
                  <div class="search-item-description">
                    ${suggestion.description || ''}
                  </div>
                  <div class="search-item-preview">
                    ${img}
                  </div>
                </div>
              `;
              return html;
            }
          }
        }]).on('autocomplete:selected', function(event, suggestion) {
          window.location.href = offsetURL(suggestion.path);
        });
        // remove inline display style on autocompleter (we want to
        // manage responsive display via css)
        $('.algolia-autocomplete').css("display", "");
      })
      .catch(function(error) {
        console.log(error);
      });

  });

  </script>

  <style type="text/css">

  .nav-search {
    font-size: x-small;
  }

  /* Algolioa Autocomplete */

  .algolia-autocomplete {
    display: inline-block;
    margin-left: 10px;
    vertical-align: sub;
    background-color: white;
    color: black;
    padding: 6px;
    padding-top: 8px;
    padding-bottom: 0;
    border-radius: 6px;
    border: 1px #0F2E3D solid;
    width: 180px;
  }


  @media screen and (max-width: 768px) {
    .distill-site-nav .algolia-autocomplete {
      display: none;
      visibility: hidden;
    }
    .distill-site-nav.responsive .algolia-autocomplete {
      display: inline-block;
      visibility: visible;
    }
    .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
      margin-left: 0;
      width: 400px;
      max-height: 400px;
    }
  }

  .algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
    width: 90%;
    outline: none;
    border: none;
  }

  .algolia-autocomplete .aa-hint {
    color: #999;
  }
  .algolia-autocomplete .aa-dropdown-menu {
    width: 550px;
    max-height: 70vh;
    overflow-x: visible;
    overflow-y: scroll;
    padding: 5px;
    margin-top: 3px;
    margin-left: -150px;
    background-color: #fff;
    border-radius: 5px;
    border: 1px solid #999;
    border-top: none;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
    cursor: pointer;
    padding: 5px 4px;
    border-bottom: 1px solid #eee;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
    border-bottom: none;
    margin-bottom: 2px;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
    overflow: hidden;
    font-size: 0.8em;
    line-height: 1.4em;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
    font-size: 1rem;
    margin-block-start: 0;
    margin-block-end: 5px;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
    display: inline-block;
    overflow: hidden;
    height: 2.8em;
    width: 80%;
    margin-right: 4%;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
    display: inline-block;
    width: 15%;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
    height: 3em;
    width: auto;
    display: none;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
    display: initial;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
    background-color: #eee;
  }
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
    font-weight: bold;
    font-style: normal;
  }

  </style>


  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure img {
    width: 100%;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        var refHtml = $('#ref-' + $(this).attr('data-cites')).html();
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <!--/radix_placeholder_distill-->
  <script src="site_libs/header-attrs-2.9/header-attrs.js"></script>
  <script src="site_libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
  <script src="site_libs/jquery-1.12.4/jquery.min.js"></script>
  <link href="site_libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
  <script src="site_libs/leaflet-1.3.1/leaflet.js"></script>
  <link href="site_libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
  <script src="site_libs/proj4-2.6.2/proj4.min.js"></script>
  <script src="site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
  <link href="site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
  <script src="site_libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
  <script src="site_libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
  <script src="site_libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>
  <link href="site_libs/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
  <script src="site_libs/HomeButton-0.0.1/home-button.js"></script>
  <script src="site_libs/HomeButton-0.0.1/easy-button-src.min.js"></script>
  <script src="site_libs/clipboard-0.0.1/setClipboardText.js"></script>
  <link href="site_libs/mapviewCSS-0.0.1/mapview-popup.css" rel="stylesheet" />
  <link href="site_libs/mapviewCSS-0.0.1/mapview.css" rel="stylesheet" />
  <script src="site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <style type="text/css">
  @import url('https://fonts.googleapis.com/css?family=Lora:400,400i&display=swap');
  @import url('https://fonts.googleapis.com/css?family=Roboto:400,400i&display=swap');


  body {font-size: 15px; line-height: 1.6;}
  h1 {
    font-size: 40px;
    line-height: 1.2em;
  }
  h2 {
    font-size: 30px;
    line-height: 1.2em;
  }
  h3 {
    font-size: 23px;
    line-height: 1.2em;
  }


  .navbar-inverse {
   background-color:#002855;
   border-color:#004088
  }

  .navbar-inverse .navbar-text {
   color:#ffffff
  }

  body {
      font-size: 15px;
  }

  p {
      font-size: 1.1em;
  }

  pre {
      font-size: 15px;
  }

  /*blue comment box */
  .blue {
      background-color:#e6f0ff;
      border-radius: 4px;
      padding: 12px;
  }

  /* add a summary click box option */

  /* turn off arrow completely in summary box */
  summary::-webkit-details-marker {
    display: none;
  }

  /* make marker something before click */
  summary::before {
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      content: "\f13a";
      color: #228B22;
  }

  /* and after click */
  details[open] summary:before {
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      content: "\f139";
      color: gray;
  }

  .challenge-ans-title {
    font-size: 18px;
    line-height: 1.5em;
    font-family: "Roboto";
    background-color:#e6f0ff;
    text-transform: uppercase;
    font-style: bold;
    letter-spacing: 0.1em;
  }

  .challenge-ans-body {
    padding: 1em;
    background-color:#e6f0ff;
    font-family: 'Lora';
        font-size: 16px;
        font-weight: normal;
  }

  .extra-practice-title {
    font-size: 16px;
    line-height: 1.5em;
    font-family: "Roboto";
    background-color: #D9E8E1;
    letter-spacing: 0.1em;
  }

  .extra-practice-body {
    padding: 1em;
    background-color: #D9E8E1;
    font-family: 'Lora';
        font-size: 16px;
        font-weight: normal;
  }

  /* see giraffe teacup site for great css tips: https://github.com/tinystats/teacups-giraffes-and-statistics/blob/master/assets/style.css
  css below is adapted from that page */

  .obj {
    border: 4px #002855;
    border-style: solid;
    padding: 1em;
    margin: 1em 0;
    min-height: 120px;
    /*color: #638f9d;*/
    color: #002855;
    background-color: #ffffff;
    font-size: 16px;
    line-height: 1.5em;
    font-family: "Roboto";
    /*background-image: url("../images/arrow.png");*/
  }

  .obj>p:first-child {
    padding-top: 0;
    margin-top: 0 !important;
    font-family: "Lora";
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .challenge {
    color: #002855;
    background-color:#e6f0ff;
    border-radius: 4px;
    padding: 12px;
    font-size: 16px;
    line-height: 1.3em;
    font-family: "Roboto";
    /*background-image: url("../images/arrow.png");*/
  }

  .challenge>p:first-child {
    padding-top: 0;
    margin-top: 0 !important;
    font-family: "Lora";
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }


  /* LARGE IMAGE AT TOP OF EACH MODULE PAGE*/
  .image-descript {
      position: relative;
  }

  /*.big_image is for module pages*/

  .big_image {
    margin-top: -50px;
    margin-bottom: 2em;
    width: 100%;
  }

  .image-text{
      position: absolute;
      top:30%; /*# was 30% */
      left:0;
      right:0;
      bottom:0;
    }

  .lil-image-text {
      margin-right: auto;
      margin-bottom: 20px;
      margin-left: auto;
      text-align: center;
      display:block;
      font-family: 'Lora', serif;
        font-size: 24px;
        line-height: 1.5em;
        letter-spacing: 1px;
        font-style: italic;
        font-weight: normal;
        color: #fff;
    }

  .big-image-text {
    letter-spacing: 0.065em;
    line-height: 1em;
    font-size: 68px;
    text-transform: uppercase;
    text-align: center;
    display:block;
    color: #fff;
    margin-bottom: 3rem;
  }

  .lil-image-text-dark {
      margin-right: auto;
      margin-bottom: 24px;
      margin-left: auto;
      text-align: center;
      display:block;
      font-family: 'Lora', serif;
        font-size: 40px;
        font-weight: normal;
        line-height: 1.5em;
        letter-spacing: 1px;
        font-style: italic;
        color: #191919;
    }

  .big-image-text-dark {
    letter-spacing: 0.065em;
    line-height: 1em;
    font-size: 68px;
    text-transform: uppercase;
    text-align: center;
    display:block;
    color: #191919;
    margin-bottom: 3rem;
  }


  .color-overlay {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    background-color: rgba(0,0,0,.1);
  }


  /*grey code block*/

  .sourceCode {
    background-color:#f4f4f4;
    border-radius: 4px;
  }


  /*make the link in the appendix more readable against the grey text*/
  d-appendix a:link {
    color: blue;
    background-color: transparent;
    text-decoration: none;
  }
  d-appendix a:visited {
    color: lightblue;
    background-color: transparent;
    text-decoration: none;
  }
  d-appendix a:hover {
    color: lightblue;
    background-color: transparent;
    text-decoration: underline;
  }
  d-appendix a:active {
    color: blue;
    background-color: transparent;
    text-decoration: underline;
  }

  </style>
  <!--/radix_placeholder_site_in_header-->

  <link rel="stylesheet" href="styles.css" type="text/css"/>

</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Reproducible workflows and automation","description":"How to make computers do your bidding","authors":[]}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a href="index.html" class="title">R4WRDS Intermediate Course</a>
</div>
<div class="nav-right">
<div class="nav-dropdown">
<button class="nav-dropbtn">
Modules
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="m_install_R.html">Module 1: </a>
<a href="m_getting_started.html">Module 2: </a>
<a href="m_project_management.html">Module 3:</a>
<a href="m_importing_and_exporting_data.html">Module 4:</a>
<a href="m_ggplot.html">Module 5:</a>
<a href="m_data_structures.html">Module 6: </a>
<a href="m_dplyr.html">Module 7: </a>
<a href="m_pivots.html">Module 8: </a>
<a href="m_functions.html">Module 9: </a>
<a href="m_joins.html">Module 10: s</a>
</div>
</div>
<a href="../index.html">
<i class="fa fa-home fa-lg" aria-hidden="true"></i>
</a>
<a href="https://github.com/ryanpeek/r4wrds/">
<i class="fa fa-github fa-lg" aria-hidden="true"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Reproducible workflows and automation</h1>
<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->
<p><p>How to make computers do your bidding</p></p>
</div>


<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#reproducible-workflows-and-automation">Reproducible workflows and automation</a></li>
<li><a href="#case-study-groundwater-level-trend-analysis">Case Study: groundwater level trend analysis</a>
<ul>
<li><a href="#our-task">Our Task</a>
<ul>
<li><a href="#import-data">Import Data</a></li>
<li><a href="#mapvisualize-the-data">Map/Visualize the Data</a></li>
<li><a href="#model-trends-in-data">Model Trends in Data</a></li>
<li><a href="#nested-lists">Nested Lists</a></li>
</ul></li>
<li><a href="#how-to-write-helpful-functions">How to write helpful functions</a>
<ul>
<li><a href="#download">1. Download</a></li>
<li><a href="#read">2. Read</a></li>
<li><a href="#clean">3. Clean</a></li>
<li><a href="#model">4. Model</a></li>
<li><a href="#visualize">5. Visualize</a></li>
<li><a href="#write">6. Write</a></li>
</ul></li>
</ul></li>
<li><a href="#task-scheduling">Task scheduling</a></li>
<li><a href="#logging">Logging</a></li>
<li><a href="#when-to-not-automate">When to not automate</a></li>
<li><a href="#code-as-instructions">Code as instructions</a></li>
<li><a href="#additional-resources">Additional resources</a></li>
</ul>
</nav>
</div>
<div class="obj">
<p><strong>Learning objectives</strong></p>
<ul>
<li>Practice functional programming with iterative workflows to power reproducible analyses</li>
<li>Understand how to use nested lists within dataframes</li>
<li>Practice conditional execution</li>
<li>Discuss task schedulers and strategies to fully automate workflows<br />
</li>
</ul>
</div>
<p><br></p>
<h1 id="reproducible-workflows-and-automation">Reproducible workflows and automation</h1>
<p>In this module, we extend lessons in functional programming from the previous <a href="m_iteration.html">module on iteration</a>, as well as best practices discussed in the <a href="m_project_management.html">project management module</a> to approach a case study. Special attention is paid to automation.</p>
<p>As you expand your ability to write <code>R</code> code, <strong>automation</strong> becomes possible. “Automation” can mean different things, but generally refers to the process of replacing time that you would spend on a workflow with a computer program, or an <code>R</code> script in the context of this course. The beauty of automation is that you can create workflows that would be nearly impossible to complete in a human lifetime, and run them thousands of times, all while you’re out on a coffee break. In some circles, this is sometimes jokingly referred to as, “making computers do your bidding.” Automation happens whenever you write a program that saves you time, freeing you to do other things.</p>
<p>The very act of writing an <code>R</code> script (or program) to perform analyses is automation, because you have automated the need to point and click through various tasks and type instructions at particular times, such as in a traditional point-and-click workflow.</p>
<p>However, any <code>R</code> program you write still needs a human to run it, and perhaps you have not one, but a chain of 5 scripts that are evaluated sequentially to import, clean, model, visualize, and output data. Someone needs to run the program. Another step up the automation ladder is to wrap these 5 scripts in a single program that calls them all in sequence, like a master switch. Instead of running 5 scripts, now we only need to run 1.</p>
<p>There is still further automation potential. We can write another program to call the “master switch” at specified times, fully remove ourselves from the pipeline, and allow the program will run all on its own (although it may require maintenance from time to time).</p>
<aside>
Any time we have a fully automated program that runs on its own, <strong>logging</strong> should be implemented. Logging allows us to monitor an automated process, and diagnose and quickly fix anything that went wrong.
</aside>

<div class="layout-chunk" data-layout="l-body">
<div class="figure"><span id="fig:automate-fig"></span>
<img src="images/automation.png" alt="Automation is like watering a row of plants. Each program is like a bucket that waters one plant at a time. Wrapping the programs into a single “master switch” control script is like installing drip irrigation so that all plants are watered at once. In order to fully automate, we can set a task scheduler, which is like adding a timer onto our drip irrigation system." width="100%" />
<p class="caption">
Figure 1: <em>Automation is like watering a row of plants. Each program is like a bucket that waters one plant at a time. Wrapping the programs into a single “master switch” control script is like installing drip irrigation so that all plants are watered at once. In order to fully automate, we can set a task scheduler, which is like adding a timer onto our drip irrigation system.</em>
</p>
</div>
</div>
<p>We should always strive for at least a degree of automation represented by the left-most figure, with a set of programs for each step in our workflow, and functions abstracted out of these programs<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> to improve readability and project organization.</p>
<p>Whether or not to write wrapper programs or configure task schedulers depends on the needs of the workflow. Guidance on when and when to not automate will be discussed in this module.</p>
<p>To demonstrate varying degrees of automation in a real-life example and extend our practice of functional programming, we will focus on a case study using the DWR’s Periodic Groundwater Level Database.</p>
<p><br></p>
<h1 id="case-study-groundwater-level-trend-analysis">Case Study: groundwater level trend analysis</h1>
<p>The California Department of Water Resources publishes a routine report on groundwater level conditions that shows groundwater level trends on a point-by-point basis. Short-term (i.e., 1, 3, and 5 year) and long-term trends (i.e., 10 and 20 years) are displayed in the report.</p>

<div class="layout-chunk" data-layout="l-body">
<div class="figure"><span id="fig:ca-dwr"></span>
<img src="images/dwr_gwl.png" alt="The “California Groundwater Conditions Update - Spring 2020”, DWR (2020) demonstrates the rate and direction of groundwater level change over different time periods, shown here is the 20000-2020 trend." width="560" />
<p class="caption">
Figure 2: <em>The <a href="https://water.ca.gov/-/media/DWR-Website/Web-Pages/Programs/Groundwater-Management/Data-and-Tools/Files/Maps/Groundwater-Level-Change/DOTMAP_Reports/Spring-2020-Groundwater-DOTMAP-Report.pdf">“California Groundwater Conditions Update - Spring 2020”, DWR (2020)</a> demonstrates the rate and direction of groundwater level change over different time periods, shown here is the 20000-2020 trend.</em>
</p>
</div>
</div>
<h2 id="our-task">Our Task</h2>
<p>Let’s imagine our task is <strong><em>to assess change in groundwater level across all stations and plot it on a map</em></strong>, just as we see in the report. In the sections that follow we will calculate groundwater level change trends at representative monitoring points in the <a href="https://data.cnra.ca.gov/dataset/periodic-groundwater-level-measurements">Periodic groundwater level database</a> we have been using in this course, and demonstrate best practices in creating a reproducible, automatable pipeline.</p>
<p>Along the way, we will also cover key concepts including:</p>
<ul>
<li>conditional execution</li>
<li>functional programming with nested lists</li>
<li>tips for writing helpful functions</li>
<li>task scheduling</li>
<li>logging</li>
</ul>
<h3 id="import-data">Import Data</h3>
<p>To begin, let’s import data and join it. If your internet connection is slow, use: <code>d &lt;- read_csv(here("data", "gwl_sac.csv"))</code> to skip the step below and read in a copy of the data from a <a href="LINK_TO_COPY_HERE">github repository</a>. If you want to see how to download this data, follow along with the code below<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://here.r-lib.org/'>here</a></span><span class='op'>)</span>

<span class='co'># urls for data</span>
<span class='va'>base_url</span> <span class='op'>&lt;-</span> 
  <span class='st'>"https://data.cnra.ca.gov/dataset/dd9b15f5-6d08-4d8c-bace-37dc761a9c08/resource/"</span>
<span class='va'>urls</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span>
  <span class='va'>base_url</span>, 
  <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"af157380-fb42-4abf-b72a-6f9f98868077/download/stations.csv"</span>,
    <span class='st'>"bfa9f262-24a1-45bd-8dc8-138bc8107266/download/measurements.csv"</span>,
    <span class='st'>"f1deaa6d-2cb5-4052-a73f-08a69f26b750/download/perforations.csv"</span><span class='op'>)</span>
<span class='op'>)</span>

<span class='co'># create directory and define paths to save downloaded files</span>
<span class='fu'><a href='https://rdrr.io/r/base/files2.html'>dir.create</a></span><span class='op'>(</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"data"</span>, <span class='st'>"pgwl"</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>files_out</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"data"</span>, <span class='st'>"pgwl"</span>, <span class='fu'><a href='https://rdrr.io/r/base/basename.html'>basename</a></span><span class='op'>(</span><span class='va'>urls</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># download files</span>
<span class='fu'><a href='https://purrr.tidyverse.org/reference/map2.html'>walk2</a></span><span class='op'>(</span><span class='va'>urls</span>, <span class='va'>files_out</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/utils/download.file.html'>download.file</a></span><span class='op'>(</span><span class='va'>.x</span>, <span class='va'>.y</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># read and combine - use datatable for speed and memory management</span>
<span class='va'>d</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='va'>files_out</span>, <span class='op'>~</span><span class='fu'>data.table</span><span class='fu'>::</span><span class='fu'><a href='https://Rdatatable.gitlab.io/data.table/reference/fread.html'>fread</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://purrr.tidyverse.org/reference/reduce.html'>reduce</a></span><span class='op'>(</span><span class='va'>left_join</span>, by <span class='op'>=</span> <span class='st'>"SITE_CODE"</span><span class='op'>)</span>

<span class='co'># d contains ~2.3 million observations: filter to Sacramento County</span>
<span class='va'>d</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>d</span>, <span class='va'>COUNTY_NAME</span> <span class='op'>==</span> <span class='st'>"Sacramento"</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<aside>
<p><br></p>
<p>We use copied URLs here, but for large, standardized websites you can use <a href="https://rvest.tidyverse.org/articles/articles/selectorgadget.html"><code>{rvest}</code> and SelectorGadget</a> to automate scraping URLs and other data. We also used <code>purrr::reduce()</code> to recursively <code>left_join()</code> a list of dataframes. This is a powerful concept, because the alternative is to manually <code>left_join()</code> each list element. Read up on <code>?reduce</code> to learn more.</p>
<p><br></p>
</aside>
<div class="layout-chunk" data-layout="l-body">

</div>
<h3 id="mapvisualize-the-data">Map/Visualize the Data</h3>
<p>Now that we have our Sacramento data in <code>R</code> either by downloading it with the code above or by reading it in directly with <code>read_csv</code>, let’s transform it to an <code>sf</code> object and plot just to sanity check that we’re indeed looking at Sacramento County groundwater levels.</p>
<div class="layout-chunk" data-layout="l-page">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://r-spatial.github.io/sf/'>sf</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/r-spatial/mapview'>mapview</a></span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/mapview/man/mapviewOptions.html'>mapviewOptions</a></span><span class='op'>(</span>fgb <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span> <span class='co'># setting to help render map</span>

<span class='co'># select only columns we will use in this analysis</span>
<span class='va'>d</span> <span class='op'>&lt;-</span> <span class='va'>d</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>SITE_CODE</span>, <span class='va'>MSMT_DATE</span>, <span class='va'>WSE</span>, <span class='va'>LONGITUDE</span>, <span class='va'>LATITUDE</span>, <span class='va'>WELL_DEPTH</span><span class='op'>)</span>

<span class='co'># convert to sf object</span>
<span class='va'>d</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_as_sf.html'>st_as_sf</a></span><span class='op'>(</span><span class='va'>d</span>, coords <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"LONGITUDE"</span>, <span class='st'>"LATITUDE"</span><span class='op'>)</span>, crs <span class='op'>=</span> <span class='fl'>4269</span><span class='op'>)</span> 

<span class='co'># take the first observation per SITE_CODE since they all have </span>
<span class='co'># the same location, and plot</span>
<span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>d</span>, <span class='va'>SITE_CODE</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://rdrr.io/pkg/mapview/man/mapView.html'>mapview</a></span><span class='op'>(</span>popup <span class='op'>=</span> <span class='cn'>NULL</span>, layer.name <span class='op'>=</span> <span class='st'>"Groundwater stations"</span><span class='op'>)</span>
</code></pre>
</div>
<div id="htmlwidget-f09bfa90cf8e0f6f3b59" style="width:624px;height:384px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-f09bfa90cf8e0f6f3b59">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["CartoDB.Positron","CartoDB.Positron","CartoDB.Positron",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["CartoDB.DarkMatter","CartoDB.DarkMatter","CartoDB.DarkMatter",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenTopoMap","OpenTopoMap","OpenTopoMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["point",440]},{"method":"addCircleMarkers","args":[[38.113,38.113,38.1132,38.1343,38.144,38.144,38.1466,38.1733,38.1798,38.1809,38.199,38.2044,38.2044,38.2328,38.2377,38.2391,38.24,38.2402,38.2405,38.2411,38.2411,38.2411,38.2465,38.2471,38.2471,38.2523,38.2524,38.2542,38.2548,38.255,38.2563,38.2604,38.2613,38.2617,38.2621,38.2623,38.2623,38.2625,38.2633,38.2727,38.2732,38.2737,38.2742,38.2748,38.2792,38.2815,38.2893,38.2895,38.2899,38.2901,38.2912,38.2913,38.2916,38.292,38.292,38.2934,38.2934,38.2935,38.2936,38.2939,38.294,38.2943,38.2969,38.3,38.3003,38.3009,38.3033,38.304,38.3089,38.3116,38.3174,38.3195,38.3204,38.321,38.3213,38.3217,38.3237,38.3254,38.3264,38.327,38.3294,38.3305,38.3314,38.3322,38.3354,38.3385,38.3422,38.3434,38.3468,38.3483,38.3504,38.351,38.3527,38.3527,38.361,38.3619,38.3632,38.3636,38.3639,38.3642,38.3696,38.372,38.3728,38.3729,38.3735,38.3764,38.3791,38.3822,38.3865,38.3866,38.3884,38.3913,38.3927,38.3941,38.3945,38.4026,38.4073,38.4082,38.4092,38.4117,38.4121,38.4125,38.413,38.4147,38.415,38.4163,38.417,38.4183,38.4196,38.4199,38.4202,38.4205,38.4218,38.4244,38.4251,38.4252,38.426,38.4272,38.4325,38.4341,38.4343,38.4354,38.4374,38.4403,38.4403,38.4417,38.4425,38.4453,38.4453,38.4458,38.4461,38.4468,38.4511,38.4525,38.4526,38.4527,38.4532,38.46,38.46,38.4613,38.4619,38.4636,38.4664,38.469,38.4705,38.4705,38.4737,38.4738,38.4742,38.4756,38.4783,38.4798,38.4799,38.4799,38.4832,38.4848,38.4851,38.4853,38.4857,38.4862,38.4931,38.4931,38.4943,38.4967,38.4969,38.5021,38.5037,38.5038,38.5047,38.5089,38.5112,38.5117,38.5159,38.5177,38.519,38.5223,38.5239,38.5241,38.5259,38.5287,38.5312,38.5315,38.5326,38.5343,38.5388,38.5397,38.5411,38.5443,38.5469,38.5478,38.5537,38.5538,38.5541,38.5543,38.5552,38.5567,38.5571,38.5578,38.5608,38.5636,38.565,38.5707,38.5729,38.576,38.5774,38.5784,38.5788,38.5823,38.5825,38.5828,38.5832,38.5841,38.5841,38.5841,38.5849,38.5852,38.5873,38.5904,38.5914,38.5923,38.5945,38.5947,38.5947,38.5947,38.5947,38.5947,38.5963,38.5966,38.5969,38.5974,38.5978,38.5978,38.5979,38.598,38.5981,38.5994,38.6001,38.6005,38.6006,38.6008,38.6016,38.6034,38.6038,38.6038,38.6038,38.6038,38.6049,38.6049,38.6061,38.6069,38.6072,38.6077,38.6078,38.6081,38.6083,38.6088,38.609,38.611,38.6115,38.6117,38.6121,38.6145,38.6151,38.616,38.6175,38.6176,38.6176,38.6178,38.6181,38.6194,38.6198,38.6199,38.6201,38.6202,38.6207,38.6212,38.622,38.6222,38.6229,38.623,38.6238,38.6238,38.6247,38.6249,38.625,38.6256,38.6265,38.6272,38.6279,38.628,38.628,38.628,38.628,38.6283,38.6292,38.6296,38.6305,38.6307,38.631,38.6312,38.6314,38.6325,38.6326,38.6333,38.6343,38.6344,38.6362,38.638,38.6389,38.6402,38.641,38.641,38.6412,38.6421,38.6429,38.6433,38.6451,38.6459,38.646,38.6469,38.647,38.6471,38.6484,38.6489,38.6489,38.6494,38.6504,38.654,38.6543,38.6547,38.6576,38.6576,38.6578,38.658,38.6596,38.66,38.6613,38.6635,38.6647,38.665,38.6688,38.6697,38.6751,38.6782,38.6782,38.6782,38.6782,38.6784,38.679,38.6794,38.6814,38.682,38.6836,38.6836,38.6848,38.685,38.6853,38.6857,38.6859,38.6864,38.6864,38.6864,38.6874,38.6895,38.6904,38.6956,38.6956,38.6964,38.6974,38.6979,38.6982,38.6982,38.7,38.7,38.7,38.7,38.7,38.7016,38.7023,38.7042,38.7058,38.7081,38.7092,38.7099,38.7117,38.7117,38.7117,38.7117,38.7137,38.7138,38.7139,38.7141,38.7146,38.7216,38.7218,38.7228,38.7228,38.7253,38.731,38.7311],[-121.587,-121.587,-121.695,-121.57,-121.563,-121.563,-121.553,-121.526,-121.648,-121.529,-121.526,-121.528,-121.528,-121.507,-121.321,-121.301,-121.297,-121.37,-121.321,-121.489,-121.489,-121.486,-121.479,-121.481,-121.481,-121.232,-121.233,-121.34,-121.291,-121.37,-121.477,-121.467,-121.209,-121.351,-121.283,-121.245,-121.297,-121.263,-121.199,-121.172,-121.361,-121.235,-121.419,-121.482,-121.265,-121.459,-121.213,-121.297,-121.442,-121.312,-121.363,-121.313,-121.408,-121.236,-121.419,-121.39,-121.39,-121.133,-121.175,-121.39,-121.338,-121.264,-121.337,-121.171,-121.348,-121.422,-121.208,-121.401,-121.321,-121.245,-121.295,-121.473,-121.443,-121.392,-121.233,-121.307,-121.327,-121.325,-121.319,-121.474,-121.19,-121.149,-121.464,-121.094,-121.418,-121.266,-121.34,-121.437,-121.139,-121.328,-121.297,-121.374,-121.108,-121.108,-121.483,-121.418,-121.451,-121.292,-121.244,-121.311,-121.193,-121.078,-121.455,-121.364,-121.334,-121.43,-121.169,-121.224,-121.281,-121.37,-121.417,-121.414,-121.169,-121.358,-121.445,-121.264,-121.385,-121.385,-121.345,-121.274,-121.21,-121.495,-121.318,-121.451,-121.324,-121.177,-121.3,-121.212,-121.473,-121.464,-121.374,-121.046,-121.225,-121.437,-121.335,-121.2,-121.285,-121.402,-121.443,-121.269,-121.462,-121.193,-121.402,-121.292,-121.292,-121.335,-121.303,-121.373,-121.463,-121.46,-121.163,-121.223,-121.236,-121.309,-121.169,-121.175,-121.286,-121.143,-121.41,-121.113,-121.232,-121.043,-121.477,-121.26,-121.259,-121.304,-121.508,-121.425,-121.315,-121.335,-121.231,-121.261,-121.206,-121.232,-121.148,-121.219,-121.434,-121.07,-121.208,-121.373,-121.18,-121.262,-121.195,-121.334,-121.302,-121.495,-121.247,-121.22,-121.364,-121.461,-121.314,-121.324,-121.285,-121.262,-121.302,-121.363,-121.469,-121.198,-121.336,-121.335,-121.501,-121.225,-121.195,-121.428,-121.328,-121.474,-121.31,-121.474,-121.339,-121.427,-121.437,-121.259,-121.181,-121.259,-121.222,-121.475,-121.225,-121.324,-121.249,-121.349,-121.5,-121.187,-121.51,-121.403,-121.489,-121.466,-121.411,-121.338,-121.408,-121.338,-121.337,-121.353,-121.353,-121.419,-121.317,-121.3,-121.358,-121.376,-121.248,-121.162,-121.352,-121.398,-121.398,-121.398,-121.398,-121.398,-121.427,-121.458,-121.459,-121.271,-121.381,-121.398,-121.36,-121.369,-121.195,-121.445,-121.417,-121.359,-121.447,-121.549,-121.376,-121.354,-121.388,-121.388,-121.388,-121.436,-121.343,-121.439,-121.531,-121.398,-121.442,-121.431,-121.271,-121.271,-121.36,-121.257,-121.292,-121.363,-121.479,-121.315,-121.555,-121.35,-121.447,-121.505,-121.412,-121.247,-121.247,-121.424,-121.359,-121.333,-121.396,-121.539,-121.419,-121.432,-121.443,-121.421,-121.477,-121.446,-121.414,-121.336,-121.374,-121.387,-121.461,-121.362,-121.359,-121.467,-121.428,-121.476,-121.359,-121.349,-121.349,-121.349,-121.349,-121.435,-121.488,-121.42,-121.398,-121.466,-121.386,-121.23,-121.218,-121.397,-121.402,-121.435,-121.411,-121.413,-121.375,-121.445,-121.343,-121.413,-121.4,-121.434,-121.37,-121.558,-121.267,-121.27,-121.307,-121.392,-121.384,-121.458,-121.468,-121.45,-121.372,-121.557,-121.568,-121.565,-121.291,-121.211,-121.447,-121.532,-121.291,-121.485,-121.188,-121.465,-121.256,-121.616,-121.293,-121.349,-121.248,-121.178,-121.454,-121.311,-121.315,-121.594,-121.594,-121.594,-121.594,-121.29,-121.321,-121.286,-121.381,-121.489,-121.454,-121.454,-121.615,-121.522,-121.608,-121.621,-121.373,-121.522,-121.522,-121.522,-121.221,-121.117,-121.476,-121.276,-121.53,-121.312,-121.278,-121.233,-121.399,-121.399,-121.218,-121.353,-121.353,-121.353,-121.353,-121.315,-121.558,-121.531,-121.36,-121.211,-121.33,-121.357,-121.333,-121.333,-121.333,-121.333,-121.491,-121.505,-121.546,-121.243,-121.422,-121.384,-121.468,-121.33,-121.33,-121.522,-121.506,-121.494],6,null,"Groundwater stations",{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"pane":"point","stroke":true,"color":"#333333","weight":1,"opacity":0.9,"fill":true,"fillColor":"#6666FF","fillOpacity":0.6},null,null,null,{"maxWidth":800,"minWidth":50,"autoPan":true,"keepInView":false,"closeButton":true,"closeOnClick":true,"className":""},["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255","256","257","258","259","260","261","262","263","264","265","266","267","268","269","270","271","272","273","274","275","276","277","278","279","280","281","282","283","284","285","286","287","288","289","290","291","292","293","294","295","296","297","298","299","300","301","302","303","304","305","306","307","308","309","310","311","312","313","314","315","316","317","318","319","320","321","322","323","324","325","326","327","328","329","330","331","332","333","334","335","336","337","338","339","340","341","342","343","344","345","346","347","348","349","350","351","352","353","354","355","356","357","358","359","360","361","362","363","364","365","366","367","368","369","370","371","372","373","374","375","376","377","378","379","380","381","382","383","384","385","386","387","388","389","390","391","392","393","394","395","396","397","398","399","400","401","402","403","404","405","406","407","408","409","410","411","412","413","414","415","416","417","418","419","420"],{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addHomeButton","args":[-121.695,38.113,-121.043,38.7311,true,"Groundwater stations","Zoom to Groundwater stations","<strong> Groundwater stations <\/strong>","bottomright"]},{"method":"addLayersControl","args":[["CartoDB.Positron","CartoDB.DarkMatter","OpenStreetMap","Esri.WorldImagery","OpenTopoMap"],"Groundwater stations",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addLegend","args":[{"colors":["#6666FF"],"labels":["Groundwater stations"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"factor","title":"","extra":null,"layerId":null,"className":"info legend","group":"Groundwater stations"}]}],"limits":{"lat":[38.113,38.7311],"lng":[-121.695,-121.043]},"fitBounds":[38.113,-121.695,38.7311,-121.043,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>
</div>
<h3 id="model-trends-in-data">Model Trends in Data</h3>
<p>Recall that we want to assess change in groundwater level across all stations and plot it on a map. In other words, assume we have the linear model describing a set of groundwater elevations (<span class="math inline">\(\hat{Y}_i\)</span>), as a function of time (<span class="math inline">\(X_i\)</span>), proportional to some unknown y-intercept (<span class="math inline">\(\beta_0\)</span>) and coefficient (<span class="math inline">\(\beta_1\)</span>) for a set of observations at times <span class="math inline">\(i = 1, ..., n\)</span>:</p>
<p><span class="math display">\[
\hat{Y}_i = \beta_0 + \beta_1(X_i) + \epsilon_i
\]</span></p>
<p>Time alone is actually a poor predictor of groundwater level (and shouldn’t be interpreted in a strict statistical sense), but for our purposes, the linear model above is useful because the <span class="math inline">\(\beta_1\)</span> coefficient can be interpreted as the average groundwater level trend at a monitoring site over some time frame. If <span class="math inline">\(\beta_1 &gt; 0\)</span>, the average groundwater level is increasing, and if <span class="math inline">\(\beta_1 &lt; 0\)</span>, it is decreasing. The magnitude of <span class="math inline">\(\beta_1\)</span> tells us by how much the groundwater level is increasing or decreasing and can be plotted per monitoring site, and compared to other monitoring sites to understand the spatial distribution of groundwater level change in a region. In this example, our region of interest is Sacramento County, but in the spirit of automation, we will create a function that allows us to apply this workflow to any county, or even the entire state of California.</p>
<p>To apply a linear model to each monitoring site, we use the <code>lm()</code> function in base <code>R</code>. If we apply the function to our entire dataset, we end up with a linear model of all groundwater levels in Sacramento county:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_line</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>MSMT_DATE</span>, <span class='va'>WSE</span>, group <span class='op'>=</span> <span class='va'>SITE_CODE</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_smooth.html'>geom_smooth</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>MSMT_DATE</span>, <span class='va'>WSE</span><span class='op'>)</span>, method <span class='op'>=</span> <span class='st'>"lm"</span>, se <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="m_reproducible_workflows_files/figure-html5/gwl-1-1.png" width="624" /></p>
</div>
<p>Let’s filter out that one outlier (groundwater levels don’t just spike by hundreds of feet so rapidly like that), filter the date range of the data to the last 20 years, and replot. We can see a slight negative groundwater level trend over the basin, but this spatial average may be skewed by monitoring stations with more data than others and increased data density in more recent years.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># recent data without the obviously erroneous outlier</span>
<span class='va'>d_recent</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>d</span>, <span class='va'>WSE</span> <span class='op'>&gt;</span><span class='op'>-</span><span class='fl'>200</span> <span class='op'>&amp;</span> <span class='va'>MSMT_DATE</span> <span class='op'>&gt;=</span> <span class='fu'>lubridate</span><span class='fu'>::</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>ymd</a></span><span class='op'>(</span><span class='st'>"2000-01-01"</span><span class='op'>)</span><span class='op'>)</span>

<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='va'>d_recent</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_line</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>MSMT_DATE</span>, <span class='va'>WSE</span>, group <span class='op'>=</span> <span class='va'>SITE_CODE</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_smooth.html'>geom_smooth</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>MSMT_DATE</span>, <span class='va'>WSE</span><span class='op'>)</span>, method <span class='op'>=</span> <span class='st'>"lm"</span>, se <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="m_reproducible_workflows_files/figure-html5/gwl-2-1.png" width="624" /></p>
</div>
<p>However, this isn’t quite what we need. What we need is a linear model for <em>each and every one of the individual stations in this dataset</em>. <code>{ggplot2}</code> is great for visualizing what we are looking for. For example, here are a few of the monitoring sites, each with a unique linear model, which can be viewed with <code>facet_wrap()</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>d_recent</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>SITE_CODE</span> <span class='op'>%in%</span> <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>$</span><span class='va'>SITE_CODE</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>7</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_line</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>MSMT_DATE</span>, <span class='va'>WSE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_smooth.html'>geom_smooth</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>MSMT_DATE</span>, <span class='va'>WSE</span><span class='op'>)</span>, method <span class='op'>=</span> <span class='st'>"lm"</span>, se <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/facet_wrap.html'>facet_wrap</a></span><span class='op'>(</span><span class='op'>~</span><span class='va'>SITE_CODE</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="m_reproducible_workflows_files/figure-html5/gwl-3-1.png" width="624" /></p>
</div>
<p>Now, it’s time to calculate those numbers with <code>lm()</code>. We will use <code>{broom}</code> to tidy up model results in a clean dataframe. Note that because the class of our <code>MSMT_DATE</code> column is <code>"POSIXct"</code>, the units returned for our coefficient <span class="math inline">\(\beta_1\)</span> will be in <span class="math inline">\(ft/sec\)</span> rather than the more intuitive <span class="math inline">\(ft/yr\)</span>, thus we define a function to handle the conversion from <span class="math inline">\(ft/sec\)</span> to <span class="math inline">\(ft/yr\)</span>. For the entire dataset the average annual change in groundwater level over the 20 year timeframe is:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># convert from seconds to years</span>
<span class='va'>sec_to_yr</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>sec</span><span class='op'>)</span><span class='op'>{</span>
  <span class='va'>yr</span> <span class='op'>&lt;-</span> <span class='va'>sec</span> <span class='op'>*</span> <span class='fl'>31557600</span>
  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>yr</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='co'># create the linear model and view output</span>
<span class='va'>m</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>WSE</span> <span class='op'>~</span> <span class='va'>MSMT_DATE</span>, data <span class='op'>=</span> <span class='va'>d_recent</span><span class='op'>)</span> 

<span class='va'>m</span>
</code></pre>
</div>
<pre><code>
Call:
lm(formula = WSE ~ MSMT_DATE, data = d_recent)

Coefficients:
(Intercept)    MSMT_DATE  
  4.614e+01   -4.462e-08  </code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># tidy the model output with broom and convert ft/sec to ft/yr</span>
<span class='fu'>broom</span><span class='fu'>::</span><span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>m</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='fl'>2</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>estimate_ft_yr <span class='op'>=</span> <span class='fu'>sec_to_yr</span><span class='op'>(</span><span class='va'>estimate</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 1 x 6
  term         estimate   std.error statistic   p.value estimate_ft_yr
  &lt;chr&gt;           &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;          &lt;dbl&gt;
1 MSMT_DA…     -4.46e-8     1.92e-9     -23.3 1.75e-117          -1.41</code></pre>
</div>
<p>From above, we see that the average annual decline is -1.41 <span class="math inline">\(ft/yr\)</span>.</p>
<h3 id="nested-lists">Nested Lists</h3>
<p>We could turn this linear model call into a function and loop over it with a <code>for</code> loop, saving each model result in a list element. We could also map this function over a list of dataframes created by <code>split(d, d$SITE_CODE)</code> (or the tidyverse equivalent, <code>group_split(d, SITE_CODE)</code>), but there’s a better way with functional programming.</p>
<p>We will use nested lists, specifically with the <code>tidyr::nest()</code> function, which allows us to convert a dataframe grouped by some variable (in our case it will be <code>SITE_CODE</code>) into a dataframe with a column that “nests” the data for each unique grouping variable. For instance:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>l</span> <span class='op'>&lt;-</span> <span class='va'>d_recent</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>SITE_CODE</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/nest.html'>nest</a></span><span class='op'>(</span><span class='op'>)</span> 
<span class='va'>l</span>
</code></pre>
</div>
<pre><code># A tibble: 302 x 2
# Groups:   SITE_CODE [302]
   SITE_CODE          data          
   &lt;chr&gt;              &lt;list&gt;        
 1 384931N1212618W001 &lt;sf [7 × 4]&gt;  
 2 384742N1213146W001 &lt;sf [7 × 4]&gt;  
 3 384798N1212614W001 &lt;sf [38 × 4]&gt; 
 4 384532N1212856W001 &lt;sf [18 × 4]&gt; 
 5 384425N1213031W001 &lt;sf [38 × 4]&gt; 
 6 384260N1212853W001 &lt;sf [19 × 4]&gt; 
 7 384251N1213346W001 &lt;sf [7 × 4]&gt;  
 8 384526N1211695W001 &lt;sf [112 × 4]&gt;
 9 384511N1212360W001 &lt;sf [19 × 4]&gt; 
10 384252N1211997W001 &lt;sf [9 × 4]&gt;  
# … with 292 more rows</code></pre>
</div>
<p>The resulting dataframe has a number of rows equal to the length of unique values in the <code>SITE_CODE</code> column, and a column called <code>data</code> with nested dataframes, one for each <code>SITE_CODE</code> (grouping variable). Notice that in the <code>data</code> column above, each nested dataframe has 4 columns, but a differing number of rows (groundwater level observations). This makes sense because each monitoring station has the same number of fields, but a different number of samples. Let’s inspect the first dataframe:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>l</span><span class='op'>$</span><span class='va'>data</span><span class='op'>[[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>]</span>
</code></pre>
</div>
<pre><code>Simple feature collection with 7 features and 3 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: -121.262 ymin: 38.4931 xmax: -121.262 ymax: 38.4931
Geodetic CRS:  NAD83
# A tibble: 7 x 4
  MSMT_DATE             WSE WELL_DEPTH           geometry
  &lt;dttm&gt;              &lt;dbl&gt;      &lt;dbl&gt;        &lt;POINT [°]&gt;
1 2004-03-01 00:00:00  -8.6        780 (-121.262 38.4931)
2 2003-10-01 00:00:00  -3.3        780 (-121.262 38.4931)
3 2003-03-15 00:00:00  -1.1        780 (-121.262 38.4931)
4 2002-10-01 00:00:00 -10.5        780 (-121.262 38.4931)
5 2001-10-01 00:00:00 -13          780 (-121.262 38.4931)
6 2001-03-15 00:00:00   1.9        780 (-121.262 38.4931)
7 2000-03-15 00:00:00  -0.2        780 (-121.262 38.4931)</code></pre>
</div>
<p>With nested data, we we can mutate new columns on the dataframe based onto the nested <code>data</code> column by mapping over each dataframe. For instance, we can add a linear model:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>d_recent</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>SITE_CODE</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='co'># nest the data per SITE_CODE grouping variable</span>
  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/nest.html'>nest</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
    <span class='co'># map a linear model onto the data</span>
    model <span class='op'>=</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='va'>data</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>WSE</span> <span class='op'>~</span> <span class='va'>MSMT_DATE</span>, data <span class='op'>=</span> <span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span>
  <span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 302 x 3
# Groups:   SITE_CODE [302]
   SITE_CODE          data           model 
   &lt;chr&gt;              &lt;list&gt;         &lt;list&gt;
 1 384931N1212618W001 &lt;sf [7 × 4]&gt;   &lt;lm&gt;  
 2 384742N1213146W001 &lt;sf [7 × 4]&gt;   &lt;lm&gt;  
 3 384798N1212614W001 &lt;sf [38 × 4]&gt;  &lt;lm&gt;  
 4 384532N1212856W001 &lt;sf [18 × 4]&gt;  &lt;lm&gt;  
 5 384425N1213031W001 &lt;sf [38 × 4]&gt;  &lt;lm&gt;  
 6 384260N1212853W001 &lt;sf [19 × 4]&gt;  &lt;lm&gt;  
 7 384251N1213346W001 &lt;sf [7 × 4]&gt;   &lt;lm&gt;  
 8 384526N1211695W001 &lt;sf [112 × 4]&gt; &lt;lm&gt;  
 9 384511N1212360W001 &lt;sf [19 × 4]&gt;  &lt;lm&gt;  
10 384252N1211997W001 &lt;sf [9 × 4]&gt;   &lt;lm&gt;  
# … with 292 more rows</code></pre>
</div>
<p>Now we have a linear model output object per <code>SITE_CODE</code>, but let’s not stop there. Let’s also mutate new columns with the intercept (<span class="math inline">\(\beta_1\)</span>), the direction and magnitude of the intercept, convert units to <span class="math inline">\(ft/yr\)</span>, and <code>unnest()</code> the data.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>d_recent</span> <span class='op'>&lt;-</span> <span class='va'>d_recent</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>SITE_CODE</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='co'># nest the data per SITE_CODE grouping variable</span>
  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/nest.html'>nest</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
    <span class='co'># map a linear model across data, extract slope magnitude &amp; direction</span>
    model     <span class='op'>=</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='va'>data</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>WSE</span> <span class='op'>~</span> <span class='va'>MSMT_DATE</span>, data <span class='op'>=</span> <span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span>,
    b1        <span class='op'>=</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='va'>model</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/stats/coef.html'>coefficients</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>[[</span><span class='st'>"MSMT_DATE"</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span>,
    b1        <span class='op'>=</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='va'>b1</span>, <span class='op'>~</span><span class='fu'>sec_to_yr</span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span>,
    direction <span class='op'>=</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='va'>b1</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>.x</span> <span class='op'>&gt;=</span> <span class='fl'>0</span>, <span class='st'>"increase"</span>, <span class='st'>"decline"</span><span class='op'>)</span><span class='op'>)</span>,
    <span class='co'># duration of the data in units of years so we know how the period</span>
    <span class='co'># over which the linear model is estimated</span>
    length_yr <span class='op'>=</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='va'>data</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/diff.html'>diff</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/range.html'>range</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>$</span><span class='va'>MSMT_DATE</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>/</span> <span class='fl'>365</span><span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='co'># unnest all columns so we can access values</span>
  <span class='fu'><a href='https://tidyr.tidyverse.org/reference/nest.html'>unnest</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>b1</span><span class='op'>:</span><span class='va'>length_yr</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>model</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<p>Take a moment to <code>View(d_recent)</code> and inspect the new columns.</p>
<p>Now we can visualize trends for each station like before. Note that not all records are a full 20 years long!</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>d_recent</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>SITE_CODE</span> <span class='op'>%in%</span> <span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>$</span><span class='va'>SITE_CODE</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>7</span><span class='op'>]</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_line</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>MSMT_DATE</span>, <span class='va'>WSE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_smooth.html'>geom_smooth</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>MSMT_DATE</span>, <span class='va'>WSE</span>, color <span class='op'>=</span> <span class='va'>direction</span><span class='op'>)</span>, method <span class='op'>=</span> <span class='st'>"lm"</span>, se <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/facet_wrap.html'>facet_wrap</a></span><span class='op'>(</span><span class='op'>~</span><span class='va'>SITE_CODE</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>color <span class='op'>=</span> <span class='st'>"Trend"</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="m_reproducible_workflows_files/figure-html5/nest5-1.png" width="624" /></p>
</div>
<p>Don’t forget that these trends have a spatial component. Let’s now only visualize sites with a <code>duration_yr</code> of 5 years or more.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># slice the first observation per SITE_ID (for location) and </span>
<span class='co'># re-convert to sf which is lost during nest and unnest</span>
<span class='va'>d_map</span> <span class='op'>&lt;-</span> <span class='va'>d_recent</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>SITE_CODE</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_as_sf.html'>st_as_sf</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>length_yr</span> <span class='op'>&gt;=</span> <span class='fl'>5</span><span class='op'>)</span>

<span class='co'># create a bin for trend magnitude that matches DWR bins (Fig 2)</span>
<span class='va'>d_map</span><span class='op'>$</span><span class='va'>bin</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cut.html'>cut</a></span><span class='op'>(</span>
  <span class='va'>d_map</span><span class='op'>$</span><span class='va'>b1</span>, 
  breaks <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>1000</span>, <span class='op'>-</span><span class='fl'>2.5</span>, <span class='fl'>0</span>, <span class='fl'>2.5</span>, <span class='fl'>1000</span><span class='op'>)</span>, 
  labels <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Increase &gt; 2.5 ft/yr"</span>, <span class='st'>"Increase 0 - 2.5 ft/yr"</span>, 
             <span class='st'>"Decrease 0 - 2.5f ft/yr"</span>, <span class='st'>"Decrease &gt; 2.5 ft/yr"</span><span class='op'>)</span>
<span class='op'>)</span>
  
<span class='co'># sacramento county polygon</span>
<span class='va'>sac</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_read.html'>st_read</a></span><span class='op'>(</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"data"</span>, <span class='st'>"shp"</span>, <span class='st'>"sac"</span>, <span class='st'>"sac_county.shp"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_transform.html'>st_transform</a></span><span class='op'>(</span><span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_crs.html'>st_crs</a></span><span class='op'>(</span><span class='va'>d_map</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Reading layer `sac_county&#39; from data source 
  `/Users/rich/Documents/GitHub/r4wrds/intermediate/data/shp/sac/sac_county.shp&#39; 
  using driver `ESRI Shapefile&#39;
Simple feature collection with 1 feature and 9 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -13565710 ymin: 4582007 xmax: -13472670 ymax: 4683976
Projected CRS: WGS 84 / Pseudo-Mercator</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># plot direction</span>
<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>sac</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>d_map</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='va'>direction</span><span class='op'>)</span>, pch <span class='op'>=</span> <span class='fl'>21</span>, size <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_void</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='st'>"Groundwater trend"</span><span class='op'>)</span>
</code></pre>
</div>
<img src="m_reproducible_workflows_files/figure-html5/nest6-1.png" width="624" />
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># plot magnitude bins</span>
<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>sac</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>d_map</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>color <span class='op'>=</span> <span class='va'>bin</span><span class='op'>)</span>, size <span class='op'>=</span> <span class='fl'>2</span>, alpha <span class='op'>=</span> <span class='fl'>0.8</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'>rcartocolor</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/rcartocolor/man/carto_scale.html'>scale_color_carto_d</a></span><span class='op'>(</span><span class='st'>"Groundwater trend"</span>, palette <span class='op'>=</span> <span class='st'>"TealRose"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_void</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="m_reproducible_workflows_files/figure-html5/nest6-2.png" width="624" /></p>
</div>
<p>The map above suggest there are only 3 locations in the basin that show an absolute change of more than 2.5 <span class="math inline">\(ft/yr\)</span>. Most of the longer term monitoring locations have an annual absolute rate of change within 0-2.5 <span class="math inline">\(ft/yr\)</span>. A quick comparison with Figure <a href="#fig:ca-dwr">2</a> suggests that our calculated groundwater level trends are similar in magnitude.</p>
<h2 id="how-to-write-helpful-functions">How to write helpful functions</h2>
<p>Everything we’ve done until this point is valuable, but is it reproducible? In the sense that we can re-run these scripts on new data, yes, but we can apply project management best practices and refactor our code into functions and programs (scripts) that are easy to re-run (Figure <a href="#fig:automate-fig">1</a>, left-most situation). We can go one step further and wrap everything into a control script (Figure <a href="#fig:automate-fig">1</a>, center situation), and in the next section, we’ll discuss how to fully automate (Figure <a href="#fig:automate-fig">1</a>, right-most situation).</p>
<p>In the spirit of “don’t repeat yourself” (DRY), it’s often said:</p>
<blockquote>
<p>If you copy paste a workflow more than 3 times, write a function.</p>
</blockquote>
<p>Recall that in this case study, we want to reevaluate groundwater level trends twice per year, once in spring and once in fall. We decide to save time in the future by abstracting these tasks into a set of functions and a central control script. We also know that others will need to use this same workflow, so we strive to turn our analysis into a reproducible tool for others and include helpful messaging, errors, and conditional execution (i.e., <code>if</code> statements) in the code.</p>
<h3 id="download">1. Download</h3>
<p>Let’s begin with the download step. Save this as <code>functions/f_wcr_download.R</code>. Notice that we add a <code>dir_out</code> argument that allows a user to specify a directory to save files to. If this path doesn’t exist, we create it. Also, we allow users to specify the urls, so if case they change in the future, this function need not change.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># download wcr data</span>
<span class='va'>f_wcr_download</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>dir_out</span>, <span class='va'>urls</span><span class='op'>)</span><span class='op'>{</span>

  <span class='co'># create directory and define paths to save downloaded files</span>
  <span class='kw'>if</span><span class='op'>(</span><span class='op'>!</span> <span class='fu'><a href='https://rdrr.io/r/base/files2.html'>dir.exists</a></span><span class='op'>(</span><span class='va'>dir_out</span><span class='op'>)</span><span class='op'>)</span><span class='op'>{</span> 
    <span class='fu'><a href='https://rdrr.io/r/base/files2.html'>dir.create</a></span><span class='op'>(</span><span class='va'>dir_out</span><span class='op'>)</span> 
  <span class='op'>}</span>
  
  <span class='co'># output file paths</span>
  <span class='va'>files_out</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/file.path.html'>file.path</a></span><span class='op'>(</span><span class='va'>dir_out</span>, <span class='fu'><a href='https://rdrr.io/r/base/basename.html'>basename</a></span><span class='op'>(</span><span class='va'>urls</span><span class='op'>)</span><span class='op'>)</span>
  
  <span class='co'># download files</span>
  <span class='fu'><a href='https://purrr.tidyverse.org/reference/map2.html'>walk2</a></span><span class='op'>(</span><span class='va'>urls</span>, <span class='va'>files_out</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/utils/download.file.html'>download.file</a></span><span class='op'>(</span><span class='va'>.x</span>, <span class='va'>.y</span><span class='op'>)</span><span class='op'>)</span>
  
<span class='op'>}</span>
</code></pre>
</div>
</div>
<h3 id="read">2. Read</h3>
<p>Next, the import function should be saved as <code>functions/f_wcr_import.R</code>. Let’s design it so that the user provides a county and a vector of input files. The function returns a helpful message in case they don’t provide a valid county. Along the way, we also provide helpful messages with <code>cat()</code> statements that print messages to the terminal as the function moves along. Messages like this are can be considered rudimentary form of logging which provides a user information on the status of a function, and may help diagnose and fix errors that may arise by showing the last place where a successful <code>cat()</code> message printed.</p>
<aside>
🐈 <code>cat()</code> stands for “concatenate and print”. It takes any number of objects, concatenates them with a space in-between, and prints them to the console. In the function below, we add <code>"/n"</code> (newlines) to each <code>cat()</code> call so that the next <code>cat()</code> message begins on a new line in the console.
</aside>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># import downloaded wcr data</span>
<span class='va'>f_wcr_import</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>county</span>, <span class='va'>files_in</span><span class='op'>)</span><span class='op'>{</span>
  <span class='co'># valid counties from entire dataset, i.e.,</span>
  <span class='co'># dput(sort(unique(d$COUNTY_NAME)))</span>
  <span class='va'>counties_valid</span> <span class='op'>&lt;-</span>
    <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Alameda"</span>, <span class='st'>"Alpine"</span>, <span class='st'>"Amador"</span>, <span class='st'>"Butte"</span>, <span class='st'>"Calaveras"</span>, <span class='st'>"Colusa"</span>,
      <span class='st'>"Contra Costa"</span>, <span class='st'>"Del Norte"</span>, <span class='st'>"El Dorado"</span>, <span class='st'>"Fresno"</span>, <span class='st'>"Glenn"</span>,
      <span class='st'>"Humboldt"</span>, <span class='st'>"Imperial"</span>, <span class='st'>"Inyo"</span>, <span class='st'>"Kern"</span>, <span class='st'>"Kings"</span>, <span class='st'>"Klamath, OR"</span>,
      <span class='st'>"Lake"</span>, <span class='st'>"Lassen"</span>, <span class='st'>"Los Angeles"</span>, <span class='st'>"Madera"</span>, <span class='st'>"Marin"</span>, <span class='st'>"Mariposa"</span>,
      <span class='st'>"Mendocino"</span>, <span class='st'>"Merced"</span>, <span class='st'>"Modoc"</span>, <span class='st'>"Mono"</span>, <span class='st'>"Monterey"</span>, <span class='st'>"Napa"</span>, <span class='st'>"Nevada"</span>,
      <span class='st'>"Orange"</span>, <span class='st'>"Placer"</span>, <span class='st'>"Plumas"</span>, <span class='st'>"Riverside"</span>, <span class='st'>"Sacramento"</span>, <span class='st'>"San Benito"</span>,
      <span class='st'>"San Bernardino"</span>, <span class='st'>"San Diego"</span>, <span class='st'>"San Francisco"</span>, <span class='st'>"San Joaquin"</span>,
      <span class='st'>"San Luis Obispo"</span>, <span class='st'>"San Mateo"</span>, <span class='st'>"Santa Barbara"</span>, <span class='st'>"Santa Clara"</span>,
      <span class='st'>"Santa Cruz"</span>, <span class='st'>"Shasta"</span>, <span class='st'>"Sierra"</span>, <span class='st'>"Siskiyou"</span>, <span class='st'>"Solano"</span>, <span class='st'>"Sonoma"</span>,
      <span class='st'>"Stanislaus"</span>, <span class='st'>"Sutter"</span>, <span class='st'>"Tehama"</span>, <span class='st'>"Tulare"</span>, <span class='st'>"Tuolumne"</span>, <span class='st'>"Ventura"</span>,
      <span class='st'>"Yolo"</span>, <span class='st'>"Yuba"</span>, <span class='st'>"ALL"</span><span class='op'>)</span>

  <span class='co'># ensure input county is valid before reading in data</span>
  <span class='kw'>if</span><span class='op'>(</span><span class='op'>!</span> <span class='va'>county</span> <span class='op'>%in%</span> <span class='va'>counties_valid</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='kw'><a href='https://rdrr.io/r/base/stop.html'>stop</a></span><span class='op'>(</span>
      <span class='fu'><a href='https://glue.tidyverse.org/reference/glue.html'>glue</a></span><span class='op'>(</span><span class='st'>"County must be one of: {paste(counties_valid, collapse = ', ')}"</span><span class='op'>)</span>,
      call. <span class='op'>=</span> <span class='cn'>FALSE</span>
    <span class='op'>)</span>
  <span class='op'>}</span>

  <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='st'>"Valid county provided, now proceeding to read data..."</span>, <span class='st'>"\n"</span><span class='op'>)</span>

  <span class='co'># read and combine - use datatable for speed and memory management</span>
  <span class='va'>d</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='va'>files_in</span>, <span class='op'>~</span><span class='fu'>data.table</span><span class='fu'>::</span><span class='fu'><a href='https://Rdatatable.gitlab.io/data.table/reference/fread.html'>fread</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://purrr.tidyverse.org/reference/reduce.html'>reduce</a></span><span class='op'>(</span><span class='va'>left_join</span>, by <span class='op'>=</span> <span class='st'>"SITE_CODE"</span><span class='op'>)</span>

  <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='st'>"Files read and combined..."</span>, <span class='st'>"\n"</span><span class='op'>)</span>

  <span class='co'># if a county is supplied (not requesting ALL the data), filter to it</span>
  <span class='kw'>if</span><span class='op'>(</span><span class='va'>county</span> <span class='op'>!=</span> <span class='st'>"ALL"</span><span class='op'>)</span><span class='op'>{</span>
    <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='st'>"Filtering to"</span>, <span class='va'>county</span>, <span class='st'>"county..."</span>, <span class='st'>"\n"</span><span class='op'>)</span>
    <span class='va'>d</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>d</span>, <span class='va'>COUNTY_NAME</span> <span class='op'>==</span> <span class='va'>county</span><span class='op'>)</span>
  <span class='op'>}</span>

  <span class='co'># select only relevant columns &amp; convert to sf object</span>
  <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='st'>"Selecting relevant columns..."</span>, <span class='st'>"\n"</span><span class='op'>)</span>
  <span class='va'>d</span> <span class='op'>&lt;-</span> <span class='va'>d</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>SITE_CODE</span>, <span class='va'>MSMT_DATE</span>, <span class='va'>WSE</span>, <span class='va'>LONGITUDE</span>, 
           <span class='va'>LATITUDE</span>, <span class='va'>WELL_DEPTH</span>, <span class='va'>COUNTY_NAME</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>LONGITUDE</span><span class='op'>)</span> <span class='op'>&amp;</span> <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>LATITUDE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_as_sf.html'>st_as_sf</a></span><span class='op'>(</span>coords <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"LONGITUDE"</span>, <span class='st'>"LATITUDE"</span><span class='op'>)</span>, crs <span class='op'>=</span> <span class='fl'>4269</span><span class='op'>)</span>

  <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='st'>"Data import complete."</span>, <span class='st'>"\n"</span><span class='op'>)</span>
  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>d</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>Notice the use of conditional execution (<code>if()</code> statements that check if certain criteria apply before proceeding), coupled with <code>stop()</code> functions that terminate the function call. It doesn’t make sense to read in an entire dataframe and filter by a county name character sting that’s not present in the data, so we check for that condition before proceeding and provide a helpful error message in case the user enters an incorrect county. We added a valid county called “ALL” which if passed to the function, doesn’t filter the data to a county, and instead returns the entire dataset. All throughout, we added helpful <code>cat()</code> messages so that as this function is chugging along, messages are printed to the console to let us know what’s happening under the hood. This also helps with debugging and logging (as we will discuss later).</p>
<p>To verify our function works as expected, let’s trigger an error message by asking it to return groundwater levels from a county that doesn’t exist in the vector of valid counties.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>f_wcr_import</span><span class='op'>(</span>county <span class='op'>=</span> <span class='st'>"Tatooine"</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<pre><code>Error: County must be one of: Alameda, Alpine, Amador, Butte, Calaveras, Colusa,
Contra Costa, Del Norte, El Dorado, Fresno, Glenn, Humboldt, Imperial, Inyo, 
Kern, Kings, Klamath, OR, Lake, Lassen, Los Angeles, Madera, Marin, Mariposa, 
Mendocino, Merced, Modoc, Mono, Monterey, Napa, Nevada, Orange, Placer, Plumas, 
Riverside, Sacramento, San Benito, San Bernardino, San Diego, San Francisco, 
San Joaquin, San Luis Obispo, San Mateo, Santa Barbara, Santa Clara, Santa Cruz,
Shasta, Sierra, Siskiyou, Solano, Sonoma, Stanislaus, Sutter, Tehama, Tulare, 
Tuolumne, Ventura, Yolo, Yuba, ALL</code></pre>
<h3 id="clean">3. Clean</h3>
<p>Next, we need to clean our data. You can imagine a much more extensive cleaning process for another dataset, but in our simple example, all we want to do is provide the user with the option to set a start and end time to filter the data by. If a start or end date is not provided, we have the function calculate the min and max date and use those.</p>
<p>Save the following code as <code>functions/f_wcr_clean.R</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># clean wcr data</span>
<span class='va'>f_wcr_clean</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>, <span class='va'>start_date</span> <span class='op'>=</span> <span class='cn'>NULL</span>, <span class='va'>end_date</span> <span class='op'>=</span> <span class='cn'>NULL</span><span class='op'>)</span><span class='op'>{</span>

  <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='st'>"Cleaning data"</span>, <span class='st'>"\n"</span><span class='op'>)</span>

  <span class='co'># if start and end date are NULL, use the min and max date</span>
  <span class='kw'>if</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/NULL.html'>is.null</a></span><span class='op'>(</span><span class='va'>start_date</span><span class='op'>)</span><span class='op'>)</span><span class='op'>{</span>
    <span class='va'>start_date</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>df</span><span class='op'>$</span><span class='va'>MSMT_DATE</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
    <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='st'>"Start date NULL, using min date:"</span>, <span class='fu'><a href='https://rdrr.io/r/base/character.html'>as.character</a></span><span class='op'>(</span><span class='va'>start_date</span><span class='op'>)</span>, <span class='st'>"\n"</span><span class='op'>)</span>
  <span class='op'>}</span>
  <span class='kw'>if</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/NULL.html'>is.null</a></span><span class='op'>(</span><span class='va'>end_date</span><span class='op'>)</span><span class='op'>)</span><span class='op'>{</span>
    <span class='va'>end_date</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>df</span><span class='op'>$</span><span class='va'>MSMT_DATE</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
    <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='st'>"End date NULL, using max date:"</span>, <span class='fu'><a href='https://rdrr.io/r/base/character.html'>as.character</a></span><span class='op'>(</span><span class='va'>end_date</span><span class='op'>)</span>, <span class='st'>"\n"</span><span class='op'>)</span>
  <span class='op'>}</span>

  <span class='co'># filter to date range and clean</span>
  <span class='va'>df</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>df</span>, <span class='va'>MSMT_DATE</span> <span class='op'>&gt;=</span> <span class='va'>start_date</span> <span class='op'>&amp;</span> <span class='va'>MSMT_DATE</span> <span class='op'>&lt;=</span> <span class='va'>end_date</span><span class='op'>)</span>

  <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span>
    <span class='st'>"Data filtered between"</span>,
    <span class='fu'><a href='https://rdrr.io/r/base/character.html'>as.character</a></span><span class='op'>(</span><span class='va'>start_date</span><span class='op'>)</span>, <span class='st'>"and"</span>,
    <span class='fu'><a href='https://rdrr.io/r/base/character.html'>as.character</a></span><span class='op'>(</span><span class='va'>end_date</span><span class='op'>)</span>,   <span class='st'>"\n "</span>
  <span class='op'>)</span>

  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>Notice that about half of this function is focused not on the transformation, but rather, setting the min and max dates if they’re not provided.</p>
<p>checking that the correct object classes are passed into the function, and sensibly imputing argument values if they’re not provided by the user (i.e., if not provided as arguments, start and end dates are assigned as the min and max dates).</p>
<p>The actual <code>filter()</code> statement only takes 1 line of code. The amount of time you should spend fine-tuning functions like so depends on how much you anticipate others using them, and how much you want to constrain their use and messaging. Not every project requires this level of detail.</p>
<div class="challenge">
<p><font color="#009E73"><strong>Extra practice: using <code>stop()</code></strong></font></p>
<p style="line-height: 1.5em;">
<p>A useful function when writing functions is <code>stop()</code>, which stops a function from running, and prints an error message. When paired with <code>if()</code>, you can build functions that test for conditions where you want the function to error.</p>
<p>For example, in the function above <code>f_wcr_clean()</code>, you may notice that the function depends on a valid date object passed in as the second and third arguments, <code>start_date</code> and <code>end_date</code>.</p>
<p>How would you use <code>if()</code> and <code>stop()</code> to verify if the supplied <code>start_date</code> and <code>end_date</code> were indeed valid date objects?</p>
</p>
<p><br></p>
<details>
<summary class="challenge-ans-title">
<font color="#0072B2"><strong>Click for the Answer!</strong></font>
</summary>
<div class="challenge-ans-body">
<p>The answer is to check the class of the supplied arguments. If they are not within an expected class of <code>c("Date", "POSIXct", "POSIXt")</code>, then we can throw an error. Look up the <code>stop()</code> documentation (<code>?stop</code>) to see what the <code>.call</code> argument does.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># clean wcr data</span>
<span class='va'>f_wcr_clean</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>, <span class='va'>start_date</span> <span class='op'>=</span> <span class='cn'>NULL</span>, <span class='va'>end_date</span> <span class='op'>=</span> <span class='cn'>NULL</span><span class='op'>)</span><span class='op'>{</span>

  <span class='co'># valid date classes</span>
  <span class='va'>valid_class</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Date"</span>, <span class='st'>"POSIXct"</span>, <span class='st'>"POSIXt"</span><span class='op'>)</span>

  <span class='co'># verify correct date class</span>
  <span class='kw'>if</span><span class='op'>(</span><span class='op'>!</span> <span class='fu'><a href='https://rdrr.io/r/base/NULL.html'>is.null</a></span><span class='op'>(</span><span class='va'>start_date</span><span class='op'>)</span> <span class='op'>&amp;</span> <span class='op'>!</span> <span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span><span class='va'>start_date</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span> <span class='op'>%in%</span> <span class='va'>valid_class</span> <span class='op'>)</span><span class='op'>{</span>
    <span class='kw'><a href='https://rdrr.io/r/base/stop.html'>stop</a></span><span class='op'>(</span>
      <span class='fu'><a href='https://glue.tidyverse.org/reference/glue.html'>glue</a></span><span class='op'>(</span>
        <span class='st'>"Invalid `start_date` class, use: {paste(valid_class, collapse=', ')}"</span>,
      <span class='op'>)</span>,
      call. <span class='op'>=</span> <span class='cn'>FALSE</span>
    <span class='op'>)</span>
  <span class='op'>}</span>
  <span class='kw'>if</span><span class='op'>(</span><span class='op'>!</span> <span class='fu'><a href='https://rdrr.io/r/base/NULL.html'>is.null</a></span><span class='op'>(</span><span class='va'>end_date</span><span class='op'>)</span> <span class='op'>&amp;</span> <span class='op'>!</span> <span class='fu'><a href='https://rdrr.io/r/base/class.html'>class</a></span><span class='op'>(</span><span class='va'>end_date</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span> <span class='op'>%in%</span> <span class='va'>valid_class</span> <span class='op'>)</span><span class='op'>{</span>
    <span class='kw'><a href='https://rdrr.io/r/base/stop.html'>stop</a></span><span class='op'>(</span>
      <span class='fu'><a href='https://glue.tidyverse.org/reference/glue.html'>glue</a></span><span class='op'>(</span>
        <span class='st'>"Invalid `end_date` class, use: {paste(valid_class, collapse=', ')}"</span>,
      <span class='op'>)</span>,
      call. <span class='op'>=</span> <span class='cn'>FALSE</span>
    <span class='op'>)</span>
  <span class='op'>}</span>

  <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='st'>"Cleaning data"</span>, <span class='st'>"\n"</span><span class='op'>)</span>

  <span class='co'># if start and end date are NULL, use the min and max date</span>
  <span class='kw'>if</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/NULL.html'>is.null</a></span><span class='op'>(</span><span class='va'>start_date</span><span class='op'>)</span><span class='op'>)</span><span class='op'>{</span>
    <span class='va'>start_date</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span><span class='op'>(</span><span class='va'>df</span><span class='op'>$</span><span class='va'>MSMT_DATE</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
    <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='st'>"Start date NULL, using min date:"</span>, <span class='fu'><a href='https://rdrr.io/r/base/character.html'>as.character</a></span><span class='op'>(</span><span class='va'>start_date</span><span class='op'>)</span>, <span class='st'>"\n"</span><span class='op'>)</span>
  <span class='op'>}</span>
  <span class='kw'>if</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/NULL.html'>is.null</a></span><span class='op'>(</span><span class='va'>end_date</span><span class='op'>)</span><span class='op'>)</span><span class='op'>{</span>
    <span class='va'>end_date</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>max</a></span><span class='op'>(</span><span class='va'>df</span><span class='op'>$</span><span class='va'>MSMT_DATE</span>, na.rm <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
    <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='st'>"End date NULL, using max date:"</span>, <span class='fu'><a href='https://rdrr.io/r/base/character.html'>as.character</a></span><span class='op'>(</span><span class='va'>end_date</span><span class='op'>)</span>, <span class='st'>"\n"</span><span class='op'>)</span>
  <span class='op'>}</span>

  <span class='co'># filter to date range and clean</span>
  <span class='va'>df</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>df</span>, <span class='va'>MSMT_DATE</span> <span class='op'>&gt;=</span> <span class='va'>start_date</span> <span class='op'>&amp;</span> <span class='va'>MSMT_DATE</span> <span class='op'>&lt;=</span> <span class='va'>end_date</span><span class='op'>)</span>

  <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span>
    <span class='st'>"Data filtered between"</span>,
    <span class='fu'><a href='https://rdrr.io/r/base/character.html'>as.character</a></span><span class='op'>(</span><span class='va'>start_date</span><span class='op'>)</span>, <span class='st'>"and"</span>,
    <span class='fu'><a href='https://rdrr.io/r/base/character.html'>as.character</a></span><span class='op'>(</span><span class='va'>end_date</span><span class='op'>)</span>,   <span class='st'>"\n "</span>
  <span class='op'>)</span>

  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
</div>
</details>
</div>
<p><br></p>
<h3 id="model">4. Model</h3>
<p>Moving on, after cleaning, it’s time to model. Save another function <code>functions/f_wcr_model.R</code> that calculates the linear model at each <code>SITE_CODE</code>:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># build linear model for each unique SITE ID and</span>
<span class='co'># add important columns (direction), beta_1 coefficient</span>
<span class='va'>sec_to_yr</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>sec</span><span class='op'>)</span><span class='op'>{</span>
  <span class='va'>yr</span> <span class='op'>&lt;-</span> <span class='va'>sec</span> <span class='op'>*</span> <span class='fl'>31557600</span>
  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>yr</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>f_wcr_model</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span><span class='op'>{</span>
  <span class='va'>result</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>SITE_CODE</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='co'># nest the data per SITE_CODE grouping variable</span>
    <span class='fu'><a href='https://tidyr.tidyverse.org/reference/nest.html'>nest</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
      <span class='co'># map a linear model across data, extract slope magnitude &amp; direction</span>
      model     <span class='op'>=</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='va'>data</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/stats/lm.html'>lm</a></span><span class='op'>(</span><span class='va'>WSE</span> <span class='op'>~</span> <span class='va'>MSMT_DATE</span>, data <span class='op'>=</span> <span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span>,
      b1        <span class='op'>=</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='va'>model</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/stats/coef.html'>coefficients</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>[[</span><span class='st'>"MSMT_DATE"</span><span class='op'>]</span><span class='op'>]</span><span class='op'>)</span>,
      b1        <span class='op'>=</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='va'>b1</span>, <span class='op'>~</span><span class='fu'>sec_to_yr</span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span>,
      direction <span class='op'>=</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='va'>b1</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>.x</span> <span class='op'>&gt;=</span> <span class='fl'>0</span>, <span class='st'>"increase"</span>, <span class='st'>"decline"</span><span class='op'>)</span><span class='op'>)</span>,
      <span class='co'># duration of the data in units of years so we know how the period</span>
      <span class='co'># over which the linear model is estimated</span>
      length_yr <span class='op'>=</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='va'>data</span>, <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/diff.html'>diff</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/range.html'>range</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>$</span><span class='va'>MSMT_DATE</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>/</span> <span class='fl'>365</span><span class='op'>)</span>
    <span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='co'># unnest all columns so we can access values</span>
    <span class='fu'><a href='https://tidyr.tidyverse.org/reference/nest.html'>unnest</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>data</span>, <span class='va'>b1</span><span class='op'>:</span><span class='va'>length_yr</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>model</span><span class='op'>)</span>

  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>result</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<h3 id="visualize">5. Visualize</h3>
<p>Next, we need to visualize and save these data. Add another function <code>functions/f_wcr_visualize_map.R</code> which creates the reproduced DWR map above.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># visualize results </span>
<span class='va'>f_wcr_visualize_map</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>, <span class='va'>yr_min</span><span class='op'>)</span><span class='op'>{</span>

  <span class='co'># slice the first observation per SITE_ID (for location) and</span>
  <span class='co'># re-convert to sf which is lost during nest and unnest</span>
  <span class='va'>d_map</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>SITE_CODE</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_as_sf.html'>st_as_sf</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>length_yr</span> <span class='op'>&gt;=</span> <span class='va'>yr_min</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='co'># create a bin for trend magnitude that matches DWR bins (Fig 2)</span>
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
      bin <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/cut.html'>cut</a></span><span class='op'>(</span>
        <span class='va'>b1</span>,
        breaks <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>1000</span>, <span class='op'>-</span><span class='fl'>2.5</span>, <span class='fl'>0</span>, <span class='fl'>2.5</span>, <span class='fl'>1000</span><span class='op'>)</span>,
        labels <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Increase &gt; 2.5 ft/yr"</span>, <span class='st'>"Increase 0 - 2.5 ft/yr"</span>,
                   <span class='st'>"Decrease 0 - 2.5f ft/yr"</span>, <span class='st'>"Decrease &gt; 2.5 ft/yr"</span><span class='op'>)</span>
      <span class='op'>)</span>
    <span class='op'>)</span>

  <span class='co'># sacramento county polygon</span>
  <span class='va'>sac</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_read.html'>st_read</a></span><span class='op'>(</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"data"</span>, <span class='st'>"shp"</span>, <span class='st'>"sac"</span>, <span class='st'>"sac_county.shp"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_transform.html'>st_transform</a></span><span class='op'>(</span><span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_crs.html'>st_crs</a></span><span class='op'>(</span><span class='va'>d_map</span><span class='op'>)</span><span class='op'>)</span>

  <span class='co'># plot magnitude bins</span>
  <span class='va'>p</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>sac</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>d_map</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>fill <span class='op'>=</span> <span class='va'>bin</span><span class='op'>)</span>, pch <span class='op'>=</span> <span class='fl'>21</span>, size <span class='op'>=</span> <span class='fl'>3</span>, alpha <span class='op'>=</span> <span class='fl'>0.9</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>rcartocolor</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/rcartocolor/man/carto_scale.html'>scale_fill_carto_d</a></span><span class='op'>(</span><span class='st'>""</span>, palette <span class='op'>=</span> <span class='st'>"TealRose"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_void</a></span><span class='op'>(</span><span class='op'>)</span>

  <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>p</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>Add another function <code>functions/f_wcr_visualize_timeseries.R</code> which writes a plot of the groundwater level over time, and shows its location on a map.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># visualize timeseries of groundwater level with a map</span>
<span class='va'>f_wcr_visualize_timeseries</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>df</span>, <span class='va'>dir_out</span><span class='op'>)</span><span class='op'>{</span>
  <span class='fu'><a href='https://rdrr.io/r/base/files2.html'>dir.create</a></span><span class='op'>(</span><span class='va'>dir_out</span><span class='op'>)</span>

  <span class='co'># color of trend - up or down</span>
  <span class='va'>col_trend</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>df</span><span class='op'>$</span><span class='va'>direction</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span> <span class='op'>==</span> <span class='st'>"decline"</span>, <span class='st'>"red"</span>, <span class='st'>"blue"</span><span class='op'>)</span>

  <span class='co'># create the hydrograph</span>
  <span class='va'>p_hydrograph</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>MSMT_DATE</span>, <span class='va'>WSE</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_line</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_smooth.html'>geom_smooth</a></span><span class='op'>(</span>
      color <span class='op'>=</span> <span class='va'>col_trend</span>, method <span class='op'>=</span> <span class='st'>"lm"</span>, se <span class='op'>=</span> <span class='cn'>FALSE</span>,
      lwd <span class='op'>=</span> <span class='fl'>2</span>, linetype <span class='op'>=</span> <span class='st'>"dashed"</span>
      <span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guides.html'>guides</a></span><span class='op'>(</span>color <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>title <span class='op'>=</span> <span class='fu'>glue</span><span class='fu'>::</span><span class='fu'><a href='https://glue.tidyverse.org/reference/glue.html'>glue</a></span><span class='op'>(</span><span class='st'>"{df$SITE_CODE[1]}, {round(df$b1[1], 2)} ft/yr"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_minimal</a></span><span class='op'>(</span><span class='op'>)</span>

  <span class='co'># create the map</span>
  <span class='co'># make measurements data spatial if not already</span>
  <span class='va'>df_sf</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_as_sf.html'>st_as_sf</a></span><span class='op'>(</span><span class='va'>df</span><span class='op'>)</span>

  <span class='co'># sacramento county polygon</span>
  <span class='va'>sac</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_read.html'>st_read</a></span><span class='op'>(</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"data"</span>, <span class='st'>"shp"</span>, <span class='st'>"sac"</span>, <span class='st'>"sac_county.shp"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_transform.html'>st_transform</a></span><span class='op'>(</span><span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_crs.html'>st_crs</a></span><span class='op'>(</span><span class='va'>df_sf</span><span class='op'>)</span><span class='op'>)</span>

  <span class='co'># map</span>
  <span class='va'>p_map</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>sac</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_void</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsf.html'>geom_sf</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>df_sf</span><span class='op'>[</span><span class='fl'>1</span>, <span class='op'>]</span>, color <span class='op'>=</span> <span class='va'>col_trend</span>, size <span class='op'>=</span> <span class='fl'>4</span>, alpha <span class='op'>=</span> <span class='fl'>0.9</span><span class='op'>)</span>

  <span class='co'># combine plots: requires {pathwork}</span>
  <span class='va'>p_combined</span> <span class='op'>&lt;-</span> <span class='va'>p_map</span> <span class='op'>+</span> <span class='va'>p_hydrograph</span>

  <span class='co'># save</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsave.html'>ggsave</a></span><span class='op'>(</span>
    <span class='fu'><a href='https://rdrr.io/r/base/file.path.html'>file.path</a></span><span class='op'>(</span><span class='va'>dir_out</span>, <span class='fu'>glue</span><span class='fu'>::</span><span class='fu'><a href='https://glue.tidyverse.org/reference/glue.html'>glue</a></span><span class='op'>(</span><span class='st'>"{df$SITE_CODE[1]}.png"</span><span class='op'>)</span><span class='op'>)</span>,
    <span class='va'>p_combined</span>,
    height <span class='op'>=</span> <span class='fl'>4</span>, width <span class='op'>=</span> <span class='fl'>12</span>
  <span class='op'>)</span>

<span class='op'>}</span>
</code></pre>
</div>
</div>
<h3 id="write">6. Write</h3>
<p>And finally, we want to save these data. We can write another function for that, but we can also achieve that pretty simply within the control script using functional programming, so we’ll do that.</p>
<p>Now that we have functions defined, let’s define one control module to download, import and clean, model, visualize, and write. Save this as a new file <code>code/00_control.R</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://r-spatial.github.io/sf/'>sf</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://here.r-lib.org/'>here</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>pathwork</span><span class='op'>)</span>

<span class='co'># load functions</span>
<span class='fu'><a href='https://rdrr.io/r/base/list.files.html'>list.files</a></span><span class='op'>(</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"functions"</span><span class='op'>)</span>, full.names <span class='op'>=</span> <span class='cn'>TRUE</span>, pattern <span class='op'>=</span> <span class='st'>"f_wcr"</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>walk</a></span><span class='op'>(</span><span class='op'>~</span><span class='kw'><a href='https://rdrr.io/r/base/source.html'>source</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># urls for data</span>
<span class='va'>base_url</span> <span class='op'>&lt;-</span>
  <span class='st'>"https://data.cnra.ca.gov/dataset/dd9b15f5-6d08-4d8c-bace-37dc761a9c08/resource/"</span>
<span class='va'>urls</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span>
  <span class='va'>base_url</span>,
  <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"af157380-fb42-4abf-b72a-6f9f98868077/download/stations.csv"</span>,
    <span class='st'>"bfa9f262-24a1-45bd-8dc8-138bc8107266/download/measurements.csv"</span>,
    <span class='st'>"f1deaa6d-2cb5-4052-a73f-08a69f26b750/download/perforations.csv"</span><span class='op'>)</span>
<span class='op'>)</span>

<span class='co'># data path to download files and read them</span>
<span class='va'>data_path</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"data"</span>, <span class='st'>"pgwl"</span><span class='op'>)</span>

<span class='co'># ------------------------------------------------------------------------</span>
<span class='co'># download data</span>
<span class='fu'>f_wcr_download</span><span class='op'>(</span><span class='va'>data_path</span>, urls <span class='op'>=</span> <span class='va'>urls</span><span class='op'>)</span>

<span class='co'># ------------------------------------------------------------------------</span>
<span class='co'># import, clean, and model</span>
<span class='va'>d</span> <span class='op'>&lt;-</span>
  <span class='co'># import downloaded data</span>
  <span class='fu'>f_wcr_import</span><span class='op'>(</span>
    county   <span class='op'>=</span> <span class='st'>"Sacramento"</span>,
    files_in <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.files.html'>list.files</a></span><span class='op'>(</span><span class='va'>data_path</span>, full.names <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='co'># minor cleaning of one unreasonable value</span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>WSE</span> <span class='op'>&gt;</span><span class='op'>-</span><span class='fl'>200</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='co'># clean data</span>
  <span class='fu'>f_wcr_clean</span><span class='op'>(</span>start_date <span class='op'>=</span> <span class='fu'>lubridate</span><span class='fu'>::</span><span class='fu'><a href='http://lubridate.tidyverse.org/reference/ymd.html'>ymd</a></span><span class='op'>(</span><span class='st'>"2000-01-01"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='co'># fit a linear model for each SITE_CODE group, extract beta_1</span>
  <span class='fu'>f_wcr_model</span><span class='op'>(</span><span class='op'>)</span>

<span class='co'># ------------------------------------------------------------------------</span>
<span class='co'># visualize big picture map</span>
<span class='co'># create output directory if it doesn't already exist</span>
<span class='va'>path_plot</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"results"</span>, <span class='st'>"plot"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/files2.html'>dir.create</a></span><span class='op'>(</span><span class='va'>path_plot</span><span class='op'>)</span>

<span class='va'>p</span> <span class='op'>&lt;-</span> <span class='fu'>f_wcr_visualize_map</span><span class='op'>(</span><span class='va'>d</span>, yr_min <span class='op'>=</span> <span class='fl'>5</span><span class='op'>)</span>
<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggsave.html'>ggsave</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/file.path.html'>file.path</a></span><span class='op'>(</span><span class='va'>path_plot</span>, <span class='st'>"00_ALL.png"</span><span class='op'>)</span>, <span class='va'>p</span>, height <span class='op'>=</span> <span class='fl'>6</span>, width <span class='op'>=</span> <span class='fl'>6</span><span class='op'>)</span>

<span class='co'># write all timeseries plots. use map instead of walk because we want</span>
<span class='co'># to capture output to inspect</span>
<span class='va'>safely_viz</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/safely.html'>safely</a></span><span class='op'>(</span><span class='va'>f_wcr_visualize_timeseries</span><span class='op'>)</span>
<span class='va'>errs</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_split.html'>group_split</a></span><span class='op'>(</span><span class='va'>d</span>, <span class='va'>SITE_CODE</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map</a></span><span class='op'>(</span><span class='op'>~</span><span class='fu'>safely_viz</span><span class='op'>(</span><span class='va'>.x</span>, <span class='va'>path_plot</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># ------------------------------------------------------------------------</span>
<span class='co'># write</span>
<span class='co'># create output directory if it doesn't already exist</span>
<span class='va'>path_csv</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"results"</span>, <span class='st'>"csv"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/files2.html'>dir.create</a></span><span class='op'>(</span><span class='va'>path_csv</span><span class='op'>)</span>

<span class='co'># write all results as one big csv and use default ordering to sort</span>
<span class='fu'><a href='https://readr.tidyverse.org/reference/write_delim.html'>write_csv</a></span><span class='op'>(</span><span class='va'>d</span>, <span class='fu'><a href='https://rdrr.io/r/base/file.path.html'>file.path</a></span><span class='op'>(</span><span class='va'>path_csv</span>, <span class='st'>"00_ALL.csv"</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># silently write a separate csv for each group</span>
<span class='va'>d</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://rdrr.io/r/base/split.html'>split</a></span><span class='op'>(</span><span class='va'>.</span><span class='op'>$</span><span class='va'>SITE_CODE</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>walk</a></span><span class='op'>(</span><span class='op'>~</span><span class='fu'><a href='https://readr.tidyverse.org/reference/write_delim.html'>write_csv</a></span><span class='op'>(</span><span class='va'>.x</span>, <span class='fu'><a href='https://rdrr.io/r/base/file.path.html'>file.path</a></span><span class='op'>(</span><span class='va'>path_csv</span>, <span class='fu'>glue</span><span class='fu'>::</span><span class='fu'><a href='https://glue.tidyverse.org/reference/glue.html'>glue</a></span><span class='op'>(</span><span class='st'>"{.x$SITE_CODE[1]}.csv"</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Notice the use of <code>purrr::safely()</code> when calling the <code>f_wcr_visualize_timeseries()</code> function. Sometimes, when mapping over many inputs (for instance 420 <code>SITE_CODE</code>s), we may encounter an error in one of the elements that stops the function from completing. <code>safely()</code> always succeeds, and we can go back and inspect errors because the function returns a list of results and errors (if they occur).</p>
<aside>
Another related error-handling verb is <code>possibly()</code> which works like <code>safely</code>, but allows us to specify a default value to insert for each error.
</aside>
<p>In this pipeline, we actually see some errors when we have a <code>SITE_CODE</code> with only one measurement. We can’t create a <code>geom_smooth()</code> ggplot layer with only one point, so it throws an error. But assuming we didn’t know that, we could figure it out by inspecting the output of the <code>safely()</code> function:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>errs</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://purrr.tidyverse.org/reference/transpose.html'>transpose</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://purrr.tidyverse.org/reference/as_vector.html'>simplify_all</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span> 
  <span class='fu'><a href='https://rdrr.io/r/base/unlist.html'>unlist</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<pre><code>$error.message
[1] &quot;&#39;gpar&#39; element &#39;fontsize&#39; must not be length 0&quot;

$error.call
check.length(gparname)</code></pre>
<p>We can browse <code>errs</code> to find the indices of these locations, or find them with code:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>i</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/which.html'>which</a></span><span class='op'>(</span><span class='fu'><a href='https://purrr.tidyverse.org/reference/map.html'>map_lgl</a></span><span class='op'>(</span><span class='fu'><a href='https://purrr.tidyverse.org/reference/as_vector.html'>simplify_all</a></span><span class='op'>(</span><span class='va'>errs</span><span class='op'>)</span>, <span class='op'>~</span><span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NULL.html'>is.null</a></span><span class='op'>(</span><span class='va'>.x</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>==</span> <span class='cn'>TRUE</span><span class='op'>)</span>
<span class='va'>i</span>
</code></pre>
</div>
</div>
<pre><code>[1]  54 119</code></pre>
<p>If we inspect these indices, we can verify that they only have one measurement each. By using <code>safely()</code>, we were able to not let these 2 elements stall the entire pipeline of 420 elements.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_split.html'>group_split</a></span><span class='op'>(</span><span class='va'>d</span>, <span class='va'>SITE_CODE</span><span class='op'>)</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span>
</code></pre>
</div>
</div>
<pre><code>[[1]]
# A tibble: 1 x 8
  SITE_CODE          MSMT_DATE             WSE WELL_DEPTH
  &lt;chr&gt;              &lt;dttm&gt;              &lt;dbl&gt;      &lt;int&gt;
1 383434N1214367W001 2000-04-24 00:00:00 -41.4        160
# … with 4 more variables: geometry &lt;POINT [°]&gt;, b1 &lt;dbl&gt;,
#   direction &lt;chr&gt;, length_yr &lt;dbl&gt;

[[2]]
# A tibble: 1 x 8
  SITE_CODE          MSMT_DATE             WSE WELL_DEPTH
  &lt;chr&gt;              &lt;dttm&gt;              &lt;dbl&gt;      &lt;int&gt;
1 385312N1215006W001 2001-05-29 00:00:00  1.13         75
# … with 4 more variables: geometry &lt;POINT [°]&gt;, b1 &lt;dbl&gt;,
#   direction &lt;chr&gt;, length_yr &lt;dbl&gt;</code></pre>
<p>To conclude, we abstracted our tasks to a set of functions, each contained in multiple, short, modular scripts rather than one massive and unwieldy script. This helps with maintenance, portability, and reproducibility. We used functional programming to replace <code>for</code> loops, and demonstrated how use <code>safely()</code> for error handling, as errors are a part of life when working with large lists, making requests from APIs or fileservers, and scaling processes to a large number of inputs.</p>
<p><br></p>
<div class="challenge">
<p><strong>Pause and think</strong></p>
<p>Imagine you wanted to scale this analysis beyond Sacramento county to Placer County. How would you approach this?</p>
<p>How could you scale to all counties in California?</p>
<p>What would you need to scale to all counties in the United States?</p>
</div>
<details>
<summary class="challenge-ans-title">
<strong>Click for Answers!</strong>
</summary>
<div class="challenge-ans-body">
<p>As with all things in coding, there are many ways to accomplish this, but some ways are more efficient than others.</p>
<p>Notice that <code>f_wcr_import()</code> has an argument <code>county</code>. To scale the analysis to Placer county, we would simply change the <code>county</code> argument to <code>"Placer"</code>. However, you may notice that <code>f_wcr_visualize_map()</code> and <code>f_wcr_visualize_timeseries()</code> both depend on a Sacramento county polygon, so you can swap that out with a Placer county polygon and be off to the races.</p>
<p>However, if you wanted to scale this to the state, you’d need to assemble polygons for all counties in the state. That sounds time consuming. However, as with most things, it’s good practice to google what feels like a common problem, because chances are you’re not the first person with this problem! In fact, there’s a great way to grab county data from directly within <code>R</code> using the <code>{maps}</code> package.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>maps</span><span class='op'>)</span>
<span class='va'>counties</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://r-spatial.github.io/sf/reference/st_as_sf.html'>st_as_sf</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/maps/man/map.html'>map</a></span><span class='op'>(</span><span class='st'>"county"</span>, plot <span class='op'>=</span> <span class='cn'>FALSE</span>, fill <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>counties</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/subset.html'>subset</a></span><span class='op'>(</span><span class='va'>counties</span>, <span class='fu'><a href='https://rdrr.io/r/base/grep.html'>grepl</a></span><span class='op'>(</span><span class='st'>"california"</span>, <span class='va'>counties</span><span class='op'>$</span><span class='va'>ID</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://r-spatial.github.io/sf/reference/plot.html'>plot</a></span><span class='op'>(</span><span class='va'>counties</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="m_reproducible_workflows_files/figure-html5/maps-pkg-1.png" width="624" /></p>
</div>
<p>With all California counties in hand, we can re-write the function to filter this polygon to the county of interest.</p>
<p>Going one step further, if we had a dataset of groundwater levels across the entire US, <code>{maps}</code> has county polygons for each county, so it wouldn’t be difficult to extend our code to a nationwide analysis.</p>
</div>
</details>
<p><br></p>
<h1 id="task-scheduling">Task scheduling</h1>
<p>Let’s imagine that these groundwater levels were not the DWR periodic groundwater level database, but rather a set of continuous monitoring sensors on telemetry that updated daily, and you needed to kick this pipeline off every day at 10am. Surely you wouldn’t manually run <code>00_control.R</code> every morning. You’d use a task scheduler.</p>
<p>Task schedulers vary by system. In general, they run a program at defined intervals. We won’t set one up in this course, but it’s good to know about them:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/2793389/scheduling-r-script">How to set up a task scheduler on Windows</a><br />
</li>
<li><a href="https://www.richpauloo.com/post/crontabs/">How to set up <code>cron</code>, an open source task scheduler for Linux</a></li>
</ul>
<aside>
Also check out the <a href="https://github.com/bnosac/taskscheduleR"><code>{taskscheduleR}</code></a> and <a href="https://github.com/bnosac/cronR"><code>{cronR}</code></a> packages for Windows and Linux, which have RStudio add-ins.
</aside>
<h1 id="logging">Logging</h1>
<p>Whenever code is running without your supervision on a task scheduler, things may break so it’s a good idea to print information whenever the job kicks off so you can review this information in case something doesn’t go as planned. We’ve been decorating our code with <code>cat()</code> statements that print updates to the console, and this is helpful, but we can be much more sophisticated and start <strong>logging</strong>. Logging is cornerstone in software engineering, but less so in data science. Logging is important for larger jobs that run often (e.g., anything on a task scheduler) with potential to break, or that may be subject to inputs that sufficiently change and that may breaks code.</p>
<p>A full discussion of logging is out of scope for this lesson, but you can learn more about logging by browsing these packages:</p>
<ul>
<li><a href="https://github.com/s-fleck/lgr"><code>{lgr}</code></a><br />
</li>
<li><a href="https://github.com/daroczig/logger/"><code>{logger}</code></a></li>
</ul>
<p><br></p>
<h1 id="when-to-not-automate">When to not automate</h1>
<p>As a data scientist, you’ll often perform once-over ad-hoc analyses. You may or may not need to return to these analyses, or components of the analyses. Automation takes time, and just because we have the tools to automate doesn’t mean that you always should. Whether or not you should automate depends on how often you anticipate the workflow needs to be re-evaluated. The more the workflow needs to be run, the more time we can justify spending on firming up the reproducibility and automation potential of program. When it’s not immediately apparent that automation is necessary (e.g., “a daily report of streamflow automatically scraped from 1,000 sensors that we set up on a task scheduler”) a general rule of thumb for whether or not to automate may boil down to the following consideration:</p>
<blockquote>
<p>Will the time saved in the future by automation exceed the time spent automating the process now? If so, automate.</p>
</blockquote>

<div class="layout-chunk" data-layout="l-body">
<div class="figure"><span id="fig:time-fig"></span>
<img src="images/is_it_worth_the_time.png" alt="Figure credit: xkcd, 1205" width="75%" />
<p class="caption">
Figure 3: <em>Figure credit: <a href="https://xkcd.com/1205/">xkcd, 1205</a></em>
</p>
</div>
</div>
<p>Don’t underestimate the time it can take to automate.</p>

<div class="layout-chunk" data-layout="l-body">
<div class="figure"><span id="fig:no-automate-fig"></span>
<img src="images/automation_xkcd.png" alt="Figure credit: xkcd, 1319" width="75%" />
<p class="caption">
Figure 4: <em>Figure credit: <a href="https://xkcd.com/1319/">xkcd, 1319</a></em>
</p>
</div>
</div>
<p><br></p>
<h1 id="code-as-instructions">Code as instructions</h1>
<p>We’ve all done a point-and-click analysis before that becomes unwieldy, large, and “too big to fail.” In other words, we cross our fingers and hope we’ll never have to repeat the analysis because either:</p>
<ol type="1">
<li>it took so long to complete that it would be unimaginable to spend that same amount of time repeating it<br />
</li>
<li>certain parts of the workflow were subjective, so repeating it would yield a different result<br />
</li>
<li>repeating one part of the workflow would invalidate downstream components and derivative products of the workflow, creating even more work</li>
</ol>
<p>Writing code is all about ensuring reproducibility and automation so we never find ourselves in this position. Writing <em>efficient</em> code ensures that the code is <em>easy</em> to interact with, debug, and modify.</p>
<blockquote>
<p>code = instructions</p>
</blockquote>
<p>No matter the language the code is in, whether it’s <code>R</code>, <code>Python</code>, <code>Julia</code> or something else, at its most fundamental level, code is a set of <strong>instructions</strong> to execute. In the data science world, coding allows automation of routine point-and-click tasks, and a good program (e.g., <code>.R</code> script) will replace the need to click through an analysis. Moreover, as data volume (size) and frequency (timing) increase, many point-and-click software tools are stretched to their limits and become slow or non-responsive. Code usually runs without the overhead of graphics processors, can be used again and again, and can be automated to run on its own.</p>
<p>As you grow in your capability with <code>R</code>, you will naturally find yourself able to interact with other languages and systems because at the end of the day, you’re in the business of writing instructions for computers to carry out, and these instructions usually involve similar tasks.</p>
<p><br></p>
<h1 id="additional-resources">Additional resources</h1>
<p><strong>Convert your <code>R</code> code into command line tools</strong>: RStudio is a great interactive development environment (IDE) for writing <code>R</code> code, but it’s important to remember that R is essentially a program on your computer that you can access and interact with via the command line using the utility <code>Rscript</code>. If you need to scale your work to a cluster, or your work expands to involve other programmers who may be less familiar with <code>R</code>, you may need to package your <code>R</code> code as a command line tool, which is a familiar format for data engineers, data scientists, and developers coming from other backgrounds. A command line tool is essentially a program that can be called from the command line, and passed arguments like so:</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>Rscript my_script.R arg1 arg2 arg3</span></code></pre></div>
</div>
<p>Learn more about turning your <code>R</code> code into a command line tool in <a href="https://swcarpentry.github.io/r-novice-inflammation/05-cmdline/">this Software Carpentry lesson</a>.</p>
<p><br></p>
<p><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"></p>
<p><a href="m_iteration.html" class="btn btn-secondary" style="float: left">Previous module:<br>Iteration</a> <a href="m_parameterized_reports.html" class="btn btn-secondary" style="float: right;">Next module:<br>Parameterized reports</a></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>As discussed in the project management module, <a href="m_project_management.html#abstracting-functions-from-code">abstracting functions from code</a> is a best practice of defining functions and storing them in separate scripts to keep your workspace easier to read and de-bug.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>Note that over time, the URLS in this code may change, and the data will certainly grow in volume. Thus, when comparing the output of the code to the data provided with this course, there may be differences because this code always grabs the most up-to-date data, which will probably contain more records than what we provide.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
<h3 id="updates-and-corrections">Corrections</h3>
<p>If you see mistakes or want to suggest changes, please <a href="https://github.com/ryanpeek/r4wrds/issues/new">create an issue</a> on the source repository.</p>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<div class="distill-site-nav distill-site-footer">
<p>© Copyright 2021 <a href="http://ryanpeek.org/" target = "_blank">Ryan Peek</a> and <a href="https://www.richpauloo.com/" target = "_blank">Rich Pauloo</a>.</p>
<p>Software licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache License, v2.0</a>.</p>
</div>
<!--/radix_placeholder_navigation_after_body-->


</body>

</html>
