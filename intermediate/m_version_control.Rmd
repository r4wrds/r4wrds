---
title: "Version Control with git"
description: | 
   A time machine you can share...
output: 
  distill::distill_article:
    toc: true
---

```{r setup, include=FALSE, purl=FALSE, message=FALSE}

library(knitr)
library(glue)
library(here)

```

::: {.obj}
**Learning objectives**

-   understand and use basic git commands for version control
-   develop a mindset and approach to set up and manage a version controlled project
-   identify best practices for using git collaboratively
:::

This lesson assumes folks have: 

 - Set up a Github Account
 - Installed `git` on your computer locally

## What is version control?

Why should you use version control? What is it? Version control is really a way to keep track of changes made to a document, data, or code with the added bonus that **you can revert to any previous change or point in time** *and* **you can work in parallel with multiple people on the same material.** 

The important difference between using a tool like git and Github versus cloud-based services (e.g., Dropbox, Google Docs) which are in a way, version control systems, is the ability to **control** exactly what changes and/or files get "versioned". These versions are snapshots of your work with unique identifiers along with a short `commit` message, which allows us to restore these changes at any point in time. This much finer control over specific changes by specific users is why version control is a very powerful tool (as well as a computer lifesaver when things go awry!). 

**`git`** is a version control program that is installed on your computer with associated commands we use to interact with version controlled files. **Github** is a website that allows us to store/access/share our files as *repositories*. There is a very rich and complicated set of tools and functionality with git/Github, but we'll focus on the basics and workflow in this module.

### Using version control

Some folks may just use version control as another way to backup their work^[ [Git xkcd](https://xkcd.com/1597/) ], but version control really shines when working on something collaboratively. For example, many are familiar with the situation below:

![Figure from http://www.phdcomics.com/comics/archive/phd101212s.gif](images/final_doc_phd_comics.png){width=80% .external} 

<br>

The comic shows a single thesis document, but really the situation isn't any different than a big data analysis project, or preparation of a product. A common series of steps are generally taken by a multiple people, for example:

 1. Download/gather data
 2. Clean/transform data
 3. Analyze and visualize data
 4. Produce a front facing product or report
 
The reality is when assigning these tasks (or subtask), there is often overlap. Or maybe one piece depends on another. Complex collaborative projects really require some forethought in how to set things up so everyone can seamlessly stitch their contribution into the overall fabric of a project without holding up the process for other team members.

<aside>

With version control, if changes you make break things, it's easy to revert or get back to an earlier working version using the [commit timeline](https://git-scm.com/book/en/v2/Git-Basics-Viewing-the-Commit-History), because we have access to the history our changes.

</aside>

:::challenge

<font color="#009E73">**Pause and Discuss!**</font> 

<p style="line-height: 1.5em;">
If you had 10 people to work on a big project with steps outlined above, how would you approach it? How would you break out these pieces or subtasks? How would you track progress? 
</p>
:::

<br>


This module will cover version control with **`git`**, including the basic commands, but it's important to remember:  

 > **Understanding and learning how to approach, setup, and implement collaborative projects with version control are just as important as learning `git` commands**

Developing the skills to organize and collaborate effectively by using tools like `git` to integrate work together is really at the root of successful version control! What we want you to come away with is a real understanding of not just the `git` commands but how to implement version control so it's useful (not just another way to back things up...see below).



![*Learn to leverage the power of git for things other than just a backup!* (Figure from https://xkcd.com/1597/)](images/xkcd_using_git.png){width=60% .external}

(ref:xkcdGit) *Learn to leverage the power of git for things other than just a backup! (Figure from https://xkcd.com/1597/)*

```{r, fig.cap='(ref:xkcdGit)', out.width='60%', echo=FALSE, eval=FALSE, out.extra="class=external"}

include_graphics(here("images/xkcd_using_git.png"))

```


## Learning `git` through a project

Sometimes the best way to learn is to walk through a real-world example. Let's walk through a simplified example of a common set of tasks a team may face using R and learning `git` along the way.

Lets imagine we have a team of 3 folks, <font color="#5f3dc4">**Jo**</font>, <font color="#2b8a3e">**Mo**</font>, and <font color="#e67700">**Main**</font>. Each has a unique skill set, and each knows how to use `R` and `git`. The team is tasked with downloading and visualizing flow data for a specific river gage to provide status report updates on a monthly basis, which are used for various regulatory actions (i.e., how much water is available for diversion, how flows relate to period of record averages, etc). 

```{r git1, echo=FALSE, out.width='80%', fig.cap="An example team and workflow"}

include_graphics(here("images", "team_and_task_annot.png"))

```


Let's get started! First we need to make sure everything is setup and installed.

### Setup `git` locally

We highly recommend Jenny Bryan & Jim Hester's [happygitwithr](https://happygitwithr.com) website because it covers everything (and more) that you may encounter when using `git` with R. In particular, please take a moment to check/update your `git` installation and configure Github. The following links will help with this:

 - [**Install Git**](https://happygitwithr.com/install-git.html)
 - [**Introduce yourself to Git**](https://happygitwithr.com/hello-git.html)

The {[`usethis`](https://usethis.r-lib.org/articles/articles/usethis-setup.html)} package is an excellent option to help you get things setup within R, like this:

```{r, echo=T, eval=FALSE}

library(usethis)

use_git_config(user.name = "yoda", user.email = "yoda2021@example.org")

```

Remember, we only need to do this once!^[If you ever need to edit your global/git profile, you can use a situation report, `usethis::git_sitrep()` to see what settings exist and how to diagnose problems ]

### Create a Repository

There are several ways to create repositories on Github and with RStudio^[ [see this excellent overview of the various ways to create/link an RStudio project with a Github repository](https://happygitwithr.com/usage-intro.html) ]. We recommend the *[Github first](https://happygitwithr.com/new-github-first.html#new-github-first)* option as it's easiest to intialize and manage. 

Please go to Github.com and login. From there, let's create a new repository!

:::challenge

<font color="#009E73">**Challenge**</font> 

<p style="line-height: 1.5em;">
Please take a moment and create a new repository on Github following the [happygitwithr.com instructions](https://happygitwithr.com/new-github-first.html#new-github-first). 

  - Name the repository `water-is-life`
  - Check the **Add a README file** box at the bottom
  - Make this a public repository
</p>
:::

<details>
  <summary class="challenge-ans-title"><font color="#0072B2">**Click for Answers!**</font></summary>
  <div class="challenge-ans-body">

Hopefully you see something like this before you click the green **Create Repository** button.

```{r challenge-1, out.width="90%", echo=FALSE}

include_graphics(here("images", "newrepo.png"))

```

And then afterwards, a screen like this:

```{r challenge-1b, out.width="90%", echo=FALSE}

include_graphics(here("images", "newrepo2.png"))

```

  </div>
</details>

The last piece to this is getting this repository which is currently in the "cloud" to a local copy on your computer. This is called **`cloning`**. To clone the repository to your computer, we need to do the following:

 - Copy the repository address. Make sure you've clicked **HTTPS** and the link in the box starts with `https://`. Copy that link to your clipboard.
 
```{r clonerepo, eval=T, echo=FALSE, out.width='60%'}

include_graphics(here("images", "clone_repo.png"))

```

 - Now open RStudio and navigate to **File > New Project > Version Control > Git**
 - In the ***Repository URL*** box, paste the link in, and hit **`Tab`**. The ***Project directory Name*** should automagically fill with the name of the repository. Go ahead and put this where you want it to live locally^[it's a good idea to store all your github repositories in one place, but avoid nesting git/RStudio projects inside other git/RStudio projects...it can cause headaches.] and hit **Create Project**. *Open in new session* is optional, but allows you to keep existing projects open.

 
```{r Rstudiorepo, eval=T, echo=FALSE, out.width='60%'}

include_graphics(here("images", "newRgit_proj.png"))

``` 

Great! We should now have an RStudio project that is version controlled with `git`, and there is a local copy we can work with on our computer.

### Collaborative Github Settings

Since we are working on a collaborative project, we need to make sure our collaborators have access to make changes to our repository. Let's do that now:

 - Go to Github.com and login
 - Navigate to your repository `water-is-life`
 - Click on the **`Settings`** tab at the top
 - Click on **`Manage Access`** on the side bar on the left (you may need to enter your password or authentication again)
 - Click on **`Invite Collaborator`** and enter the username or email you want to add! 

So, if <font color="#e67700">**Main**</font> created the repository, they would need to add fellow collaborators to the repository. 

<aside>

You can access any public Github repository, including copying or cloning the repo to your computer. However, unless you are the owner, or have been added as a collaborator, you will not be able to commit changes (more on this later).

</aside>
 
```{r, echo=FALSE, out.width='50%', fig.cap="Click on the Settings tab at the top to add collaborators"}

include_graphics(here("images", "git_settings.png"))

```

```{r, echo=FALSE, out.width='50%', fig.cap="Then click on Manage Access"}

include_graphics(here("images/git_manage_access.png"))

```

```{r, echo=FALSE, fig.width=3, fig.height=1.9, fig.cap="Invite collaborators by email or username!"}

include_graphics(here("images/git_invite_collaborators.png"))

```

 
### Branches & Conflicts

Often when teaching `git`, we start with the basic commands. However, it's important to consider one of the more powerful parts of using `git` is the ability to use **branches**. Branches, or branching, in `git`, is a way for multiple folks to work on the same repository independently, and a standardized way to integrate those changes back into the repository. Every repository typically starts with one single **`main`** branch. This is like the trunk of the tree, or the main train track. We can set up some additional branches off of this track, and if we want to merge them back in to make them available for our collaborators, we need to use something called a **pull request**. This is essentially a way to double check if there will be any conflicts between the work in the branch and the work in the **`main`**, and it also provides a way to document and review any changes. 

<aside>

Even if you are the only person working in a repo, it's a good habit to use branches because if you realize the branch/work you are doing is a dead end, you can always delete a branch and return to the the **`main`** track and pick things up where you last left off.

</aside>
 

```{r, echo=F, fig.cap="Example of multiple branches in a project splitting off the main branch"}

include_graphics(here("images", "commit_branch_tracks.png"))

```

### Create a branch

In our example we want to make sure we keep our **`main`** branch clean and up-to-date with changes we are happy with...all other work will go through a branch, pull request, review, and merge process to minimize conflicts or duplication of work.

<font color="#5f3dc4">**Jo**</font> is a wizard at grabbing the data we want to work with and saving it in an organized way. She's cloned the repository to her computer, and first thing she wants to do is create a fresh branch to work off of, so her changes can be reviewed before being `merged` into the **`main`** branch.

We can create a branch in RStudio in one of two ways:

 - `Tools > Terminal > New Terminal` and look for the Terminal tab in RStudio. Click on it, and at the prompt, type `git checkout -b BRANCH_NAME`.
 - Using the **`Git`** tab in RStudio and clicking on the **`New Branch`** button.

Let's create a new branch called `jo_download_data`. Ideally, each team member will do the same, and each of these branches comes from the **`main`** branch, which is the main trunk or "clean" version of the project.

(ref:startingBranch) <font color="#5f3dc4">**Jo**</font> creates a new branch from **`main`** to do her data download task.

```{r startingBranch, eval=TRUE, echo=FALSE, fig.cap='(ref:startingBranch)', out.height='80%'}

include_graphics(here("images/jo_data_gather_branch.png"))

```

 
### Download Data: `add`, `commit`, `push`

Jo's task is to download the data. Because this is a task that will need to happen regularly, she writes a function to download the specific river discharge data to an organized set of folders. She runs the function to get the most recent data, and saves it locally *on her version of the repository!*

As she works, the general process she follows is: 

 1. Do some work, add some files, scripts, etc. To version control these changes, we need to stage or `add` that work so it can be *versioned* by `git`. We do this with `git add <my_file>` or check the **`Staged`** buttons in the RStudio `git` panel.
 2. Add a `commit` message that is succinct but descriptive (i.e., `added water data files`). These are the messages you'll be able to go back to if you want to travel back in time and see a different version of something...so be kind to your future self and add something helpful. 
 3. `push` this up to the Github `remote` repository in the cloud! 
 
 Remember, you can commit as frequently as you like, and push at the end of the day, or push every time you commit. The timestamp identifier is added with a commit message, not with the push.
 

<aside>
 
 Think of every commit you make as a train station. The more commits you make (and the more descriptive they are) the easier it will be to get around...particularly because your train can travel *back in time*!
 
</aside>



### `fetch` and `pull`

 
<aside>

**Exiting `vim`**: if you end up in a text editor and aren't sure how to exit, you may be in `vim`. It is the default editor for many systems and programs. To exit without saving changes, hit **`Esc`**, then type **`:q!`** and hit **`Enter`**. To save changes, hit **`Esc`** and then type **`:wq`** and hit **`Enter`**.

</aside>


## Notes

 - the difference between public and private repos, how and why to use branching (idea of parallel work on collaborative projects), submitting a pull request.
 - `.gitignore`: use it to ignore entire directories and other files, especially files >= 125MB, and for files that you may use for internal analysis (e.g., rds) that may be quite large.
 - Basic commands: Fetch, pull, merge, branch + add/commit
 - For merge conflicts...use text file example of comment/code on same line. Show head/diff, choose one and save, hereâ€™s what it looks like on desktop, and online.



## Additional Resources & Tutorials

 - https://swcarpentry.github.io/git-novice/
 - https://learngitbranching.js.org
 - [r for excel with github](https://rstudio-conf-2020.github.io/r-for-excel/github.html)
 - [Excuse me do you have a moment to talk version control by Jenny Bryan](https://peerj.com/preprints/3159/)
 - [Github for project management](https://openscapes.github.io/series/github-issues.html)

- git vaccinate with usethis to insure no issues with hidden/secure files

- discuss committing .html, shapefiles, etc. 
- Ignore large files or data. 
